@using System.Text.Json
@model E_Invoice_system.Models.invoices

@{
    Layout = null;
    var subtotal = Model.price;
    var discount = Model.discount;
    var totalAmount = Model.total_price;

    var isMultiItem = false;
    List<Dictionary<string, object>> items = new List<Dictionary<string, object>>();

    try
    {
        if (!string.IsNullOrEmpty(Model.prod_name_service) && Model.prod_name_service.Trim().StartsWith("["))
        {
            var jsonElements = JsonSerializer.Deserialize<List<Dictionary<string, JsonElement>>>(Model.prod_name_service);
            if (jsonElements != null && jsonElements.Count > 0)
            {
                isMultiItem = true;
                foreach (var item in jsonElements)
                {
                    var newItem = new Dictionary<string, object>();
                    foreach (var kvp in item)
                    {
                        if (kvp.Value.ValueKind == JsonValueKind.Number)
                            newItem[kvp.Key] = kvp.Value.GetDecimal();
                        else if (kvp.Value.ValueKind == JsonValueKind.String)
                            newItem[kvp.Key] = kvp.Value.GetString() ?? "";
                        else
                            newItem[kvp.Key] = kvp.Value.ToString();
                    }
                    items.Add(newItem);
                }
                if (subtotal == 0 && items.Any())
                {
                    subtotal = items.Sum(i => (decimal)i["price"] * (decimal)i["qty"]);
                }
            }
        }
    }
    catch { isMultiItem = false; }
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Invoice #@(Model.invoice_no ?? Model.id.ToString())</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #f0f2f5;
            font-family: 'Montserrat', sans-serif;
            display: flex;
            justify-content: center;
            min-height: 100vh;
            padding: 0;
            margin: 0;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }

        .invoice-container {
            background: white;
            width: 210mm;
            min-height: 297mm;
            margin: 0 auto;
            position: relative;
            box-shadow: 0 20px 50px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Top Geometric Patterns */
        .top-pattern {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 220px;
            z-index: 1;
        }

        .shape-red-top {
            position: absolute;
            top: 0;
            left: 0;
            width: 180px;
            height: 180px;
            background: #BC1823;
            clip-path: polygon(0 0, 100% 0, 0 100%);
            z-index: 2;
        }

        .shape-black-top-1 {
            position: absolute;
            top: 0;
            left: 80px;
            width: 150px;
            height: 150px;
            background: #1C2120;
            clip-path: polygon(0 0, 100% 0, 40% 100%);
            z-index: 1;
            opacity: 0.9;
        }

        .shape-black-top-2 {
            position: absolute;
            top: 0;
            left: 200px;
            width: 200px;
            height: 100px;
            background: #1C2120;
            clip-path: polygon(0 0, 100% 0, 60% 100%);
            z-index: 0;
            opacity: 0.8;
        }

        .header-content {
            position: relative;
            z-index: 10;
            padding: 40px 60px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .logo-box {
            background: white;
            padding: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            border-radius: 4px;
            width: fit-content;
        }

        .logo-box img {
            height: 60px;
            width: auto;
            display: block;
        }

        .invoice-label {
            font-size: 40px;
            font-weight: 900;
            color: #BC1823;
            text-transform: uppercase;
            line-height: 1;
        }

        .invoice-no {
            font-size: 16px;
            font-weight: 700;
            color: #1C2120;
            text-align: right;
        }

        .details-section {
            padding: 0 60px 40px 60px;
            display: flex;
            justify-content: space-between;
            position: relative;
            z-index: 10;
        }

        .billing-box { width: 45%; }

        .section-label {
            background: #BC1823;
            color: white;
            padding: 4px 15px;
            font-size: 12px;
            font-weight: 800;
            display: inline-block;
            margin-bottom: 15px;
            text-transform: uppercase;
        }

        .billing-name {
            font-size: 18px;
            font-weight: 800;
            color: #1C2120;
            margin-bottom: 5px;
        }

        .billing-details {
            font-size: 14px;
            color: #4b5563;
            line-height: 1.6;
        }

        .info-bar {
            padding: 0 60px 30px 60px;
            display: flex;
            gap: 40px;
            position: relative;
            z-index: 10;
        }

        .info-label {
            font-size: 11px;
            font-weight: 700;
            color: #9ca3af;
            text-transform: uppercase;
        }

        .info-value {
            font-size: 14px;
            font-weight: 800;
            color: #111827;
        }

        .status-badge {
            padding: 2px 10px;
            border-radius: 4px;
            color: white;
            font-size: 12px;
        }

        .items-section {
            padding: 0 60px;
            flex-grow: 1;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead tr { background: #BC1823; color: white; }
        th { padding: 8px 12px; text-align: left; font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; }
        td { padding: 10px 12px; border-bottom: 1px solid #f3f4f6; font-size: 13px; color: #4b5563; }
        .text-right { text-align: right; }
        .text-center { text-align: center; }

        .bottom-section {
            padding: 40px 60px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            position: relative;
            z-index: 10;
        }

        .summary-box { width: 45%; }
        .summary-row { display: flex; justify-content: space-between; padding: 8px 0; font-size: 14px; }
        .summary-total {
            background: #BC1823;
            color: white;
            padding: 12px 24px;
            border-radius: 20px;
            margin-top: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            font-weight: 800;
            font-size: 18px;
            box-shadow: 0 4px 10px rgba(188, 24, 35, 0.1);
        }

        .signature-line {
            border-top: 2px solid #111827;
            margin-top: 50px;
            padding-top: 10px;
            font-size: 12px;
            font-weight: 800;
            text-transform: uppercase;
        }

        .signature-box { 
            text-align: center; 
            width: 180px; 
            margin-top: 30px; /* Space from Terms & Conditions */
        }

        .bottom-pattern {
            position: relative;
            height: 150px;
            width: 100%;
            margin-top: auto;
            bottom: -1px;
            right: -1px; /* Close right gap */
        }

        .shape-red-bottom {
            position: absolute;
            bottom: 0;
            left: 150px;
            width: 400px;
            height: 120px;
            background: #BC1823;
            clip-path: polygon(20% 0, 100% 100%, 0 100%);
            z-index: 2;
        }

        .shape-black-bottom-1 {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 300px;
            height: 150px;
            background: #1C2120;
            clip-path: polygon(0 0, 60% 100%, 0 100%);
            z-index: 1;
        }

        .shape-black-bottom-2 {
            position: absolute;
            bottom: 0;
            right: -1px; /* Close right gap */
            width: 251px;
            height: 100px;
            background: #1C2120;
            clip-path: polygon(40% 0, 100% 0, 100% 100%, 0 100%);
            z-index: 1;
        }

        .footer-branding {
            position: absolute !important;
            bottom: 10px !important;
            right: 20px !important;
            color: white !important;
            font-size: 8px !important;
            font-weight: 800 !important;
            letter-spacing: 1.5px !important;
            text-transform: uppercase !important;
            z-index: 99 !important;
            display: block !important;
        }

        .btn-print {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #BC1823;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-weight: 800;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 10px 20px rgba(188,24,35,0.3);
            transition: all 0.3s ease;
        }

        .btn-print:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 30px rgba(255,0,0,0.4);
        }

        @@page {
            size: A4;
            margin: 0 !important;
        }

        @@media print {
            .btn-print { display: none !important; }
            
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }

            html, body {
                visibility: hidden;
                width: 210mm !important;
                height: 296mm !important;
                background: white !important;
                margin: 0 !important;
                padding: 0 !important;
                overflow: hidden !important;
                display: block !important; 
            }

            .invoice-container, .invoice-container * {
                visibility: visible !important;
            }

            .invoice-container {
                box-shadow: none !important;
                width: 210mm !important;
                height: 296mm !important; /* Tiny reduction to avoid bleed */
                margin: 0 !important;
                padding: 0 !important;
                position: fixed !important; 
                top: 0 !important;
                left: 0 !important;
                display: block !important;
                overflow: hidden !important;
                page-break-after: avoid !important;
                transform: scale(0.99) !important; /* Subtle scale to ensure 1-page fit */
                transform-origin: top left !important;
                z-index: 9999 !important;
            }

            .bottom-pattern {
                position: absolute !important;
                bottom: -1px !important; 
                right: -1px !important; /* Close right gap */
                left: -1px !important;
                display: block !important;
                width: calc(100% + 2px) !important;
                height: 150px !important;
            }

            .shape-black-bottom-2 {
                right: -1px !important;
                bottom: -1px !important;
                width: 251px !important;
            }

            .footer-branding {
                position: absolute !important;
                bottom: 10px !important;
                right: 20px !important;
                font-size: 8px !important;
                display: block !important;
                z-index: 10000 !important;
                color: white !important;
                white-space: nowrap !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                text-transform: uppercase !important;
                letter-spacing: 1.5px !important;
            }

            .items-section {
                padding-bottom: 160px !important;
            }
        }
    </style>
</head>
<body>

    <button onclick="window.print()" class="btn-print no-print">PRINT INVOICE</button>

    <div class="invoice-container">
        <!-- Top Patterns -->
        <div class="top-pattern">
            <div class="shape-red-top"></div>
            <div class="shape-black-top-1"></div>
            <div class="shape-black-top-2"></div>
        </div>

        <div class="header-content">
            <div class="logo-section">
                <div class="logo-box">
                    <img src="/images/sata-logo.png" alt="SATA Logo" />
                </div>
            </div>
            <div class="invoice-title-section">
                <div class="invoice-label">Invoice</div>
                <div class="invoice-no"># @(Model.invoice_no ?? Model.id.ToString())</div>
            </div>
        </div>

        <!-- Billing Section -->
        <div class="details-section">
            <div class="billing-box">
                <div class="section-label">Invoice To:</div>
                <div class="billing-details">
                    <div class="billing-name">@Model.buyer_name</div>
                    <div>@Model.buyer_address</div>
                    <div>Phone: @Model.buyer_contact</div>
                </div>
            </div>
            <div class="billing-box" style="text-align: right;">
                <div class="section-label">Invoice From:</div>
                <div class="billing-details">
                    <div class="billing-name">@Model.seller_name</div>
                    <div>@Model.seller_address</div>
                    <div>Phone: @Model.seller_contact</div>
                    <div style="font-weight: 800; color: #111827; margin-top: 5px;">Date: @Model.date.ToString("dd MMM yyyy")</div>
                </div>
            </div>
        </div>

        <div class="info-bar">
            <div class="info-item">
                <div class="info-label">Status</div>
                <div class="info-value"><span class="status-badge" style="background: @(Model.status == "Paid" ? "#10b981" : "#BC1823")">@(Model.status ?? "PENDING")</span></div>
            </div>
            <div class="info-item">
                <div class="info-label">Payment Method</div>
                <div class="info-value">@(Model.payment ?? "Not Specified")</div>
            </div>
        </div>

        <!-- Items Table -->
        <div class="items-section">
            <table>
                <thead>
                    <tr>
                        <th width="50%">Item Description</th>
                        <th class="text-center">Price</th>
                        <th class="text-center">Qty</th>
                        <th class="text-right">Total</th>
                    </tr>
                </thead>
                <tbody>
                    @if (isMultiItem) {
                        foreach(var item in items) {
                            <tr>
                                <td>
                                    <div style="font-weight: 800;">@item["name"]</div>
                                    <div style="font-size: 11px; color: #6b7280;">Expiry: @(item.ContainsKey("expiryDate") ? item["expiryDate"] : "N/A")</div>
                                </td>
                                <td class="text-center">$@(((decimal)item["price"]).ToString("N2"))</td>
                                <td class="text-center">@item["qty"]</td>
                                <td class="text-right" style="font-weight: 800;">$@(((decimal)item["total"]).ToString("N2"))</td>
                            </tr>
                        }
                    } else {
                        <tr>
                            <td>
                                <div style="font-weight: 800;">@Model.prod_name_service</div>
                                <div style="font-size: 11px; color: #6b7280;">Expiry: @(ViewBag.SingleItemExpiry ?? "N/A")</div>
                            </td>
                            <td class="text-center">$@Model.price.ToString("N2")</td>
                            <td class="text-center">@Model.qty_unit_type</td>
                            <td class="text-right" style="font-weight: 800;">$@((Model.price - Model.discount).ToString("N2"))</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- Bottom Section -->
        <div class="bottom-section">
            <div style="width: 50%;">
                <div style="font-weight: 800; font-size: 14px; margin-bottom: 10px;">Terms & Conditions</div>
                <div style="font-size: 11px; color: #6b7280; line-height: 1.5;">
                    Please make payment within 15 days of receiving this invoice. 
                    Thank you for choosing SATA TECHNOLOGIES for your business needs.
                </div>
                <div class="signature-box">
                    <div class="signature-line">Authorized Signature</div>
                </div>
            </div>
            <div class="summary-box">
                <div class="summary-row">
                    <span style="font-weight: 700; color: #6b7280;">Sub Total</span>
                    <span style="font-weight: 800; color: #111827;">$@subtotal.ToString("N2")</span>
                </div>
                <div class="summary-row">
                    <span style="font-weight: 700; color: #6b7280;">Discount</span>
                    <span style="font-weight: 800; color: #BC1823;">-$@discount.ToString("N2")</span>
                </div>
                <div class="summary-total">
                    <span>Grand Total</span>
                    <span>$@totalAmount.ToString("N2")</span>
                </div>
            </div>
        </div>


        <!-- Bottom Patterns -->
        <div class="bottom-pattern">
            <div class="shape-red-bottom"></div>
            <div class="shape-black-bottom-1"></div>
            <div class="shape-black-bottom-2"></div>
        </div>
        <div class="footer-branding">SATA E-Invoice System â€¢ Innovating the Future</div>
    </div>
</body>
</html>
