@using System.Text.Json
@model E_Invoice_system.Models.invoices

@{
    var subtotal = Model.price;
    var discount = Model.discount;
    var totalAmount = Model.total_price;

    var isMultiItem = false;
    List<Dictionary<string, object>> items = new List<Dictionary<string, object>>();

    try
    {
        if (!string.IsNullOrEmpty(Model.prod_name_service) && Model.prod_name_service.Trim().StartsWith("["))
        {
            var jsonElements = JsonSerializer.Deserialize<List<Dictionary<string, JsonElement>>>(Model.prod_name_service);
            if (jsonElements != null && jsonElements.Count > 0)
            {
                isMultiItem = true;
                foreach (var item in jsonElements)
                {
                    var newItem = new Dictionary<string, object>();
                    foreach (var kvp in item)
                    {
                        if (kvp.Value.ValueKind == JsonValueKind.Number)
                            newItem[kvp.Key] = kvp.Value.GetDecimal();
                        else if (kvp.Value.ValueKind == JsonValueKind.String)
                            newItem[kvp.Key] = kvp.Value.GetString() ?? "";
                        else
                            newItem[kvp.Key] = kvp.Value.ToString();
                    }
                    items.Add(newItem);
                }
                if (subtotal == 0 && items.Any())
                {
                    subtotal = items.Sum(i => (decimal)i["price"] * (decimal)i["qty"]);
                }
            }
        }
    }
    catch { isMultiItem = false; }
}

<div class="no-print" style="display: flex; gap: 1rem; margin-bottom: 2rem; justify-content: flex-end; padding: 0 20px;">
    <button onclick="window.print()" class="btn-primary" style="background: #BC1823; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 6px; cursor: pointer; font-weight: 800; display: flex; align-items: center; gap: 8px;">
        <i class="ph-printer-bold"></i> PRINT INVOICE
    </button>
    <a asp-action="Index" class="btn-primary" style="background: #111827; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 6px; text-decoration: none; font-weight: 700;">
        <i class="ph-arrow-left"></i> BACK
    </a>
</div>

<div id="invoiceViewWrapper">
    <div class="invoice-container" id="printableInvoice">
        <!-- Top Patterns -->
        <div class="top-pattern">
            <div class="shape-red-top"></div>
            <div class="shape-black-top-1"></div>
            <div class="shape-black-top-2"></div>
        </div>

        <div class="header-content">
            <div class="logo-section">
                <div class="logo-box">
                    <img src="/images/sata-logo.png" alt="SATA Logo" />
                </div>
            </div>
            <div class="invoice-title-section">
                <div class="invoice-label">Invoice</div>
                <div class="invoice-no"># @(Model.invoice_no ?? Model.id.ToString())</div>
            </div>
        </div>

        <!-- Billing Section -->
        <div class="details-section">
            <div class="billing-box">
                <div class="section-label">Invoice To:</div>
                <div class="billing-details">
                    <div class="billing-name">@Model.buyer_name</div>
                    <div>@Model.buyer_address</div>
                    <div>Phone: @Model.buyer_contact</div>
                </div>
            </div>
            <div class="billing-box" style="text-align: right;">
                <div class="section-label">Invoice From:</div>
                <div class="billing-details">
                    <div class="billing-name">@Model.seller_name</div>
                    <div>@Model.seller_address</div>
                    <div>Phone: @Model.seller_contact</div>
                    <div style="font-weight: 800; color: #111827; margin-top: 5px;">Date: @Model.date.ToString("dd MMM yyyy")</div>
                </div>
            </div>
        </div>

        <div class="info-bar">
            <div class="info-item">
                <div class="info-label">Status</div>
                <div class="info-value"><span class="status-badge" style="background: @(Model.status == "Paid" ? "#10b981" : "#BC1823")">@(Model.status ?? "PENDING")</span></div>
            </div>
            <div class="info-item">
                <div class="info-label">Payment Method</div>
                <div class="info-value">@(Model.payment ?? "Not Specified")</div>
            </div>
        </div>

        <!-- Items Table -->
        <div class="items-section">
            <table>
                <thead>
                    <tr>
                        <th width="50%">Item Description</th>
                        <th class="text-center">Price</th>
                        <th class="text-center">Qty</th>
                        <th class="text-right">Total</th>
                    </tr>
                </thead>
                <tbody>
                    @if (isMultiItem) {
                        foreach(var item in items) {
                            <tr>
                                <td>
                                    <div style="font-weight: 800;">@item["name"]</div>
                                    <div style="font-size: 11px; color: #6b7280;">Expiry: @(item.ContainsKey("expiryDate") ? item["expiryDate"] : "N/A")</div>
                                </td>
                                <td class="text-center">$@(((decimal)item["price"]).ToString("N2"))</td>
                                <td class="text-center">@item["qty"]</td>
                                <td class="text-right" style="font-weight: 800;">$@(((decimal)item["total"]).ToString("N2"))</td>
                            </tr>
                        }
                    } else {
                        <tr>
                            <td>
                                <div style="font-weight: 800;">@Model.prod_name_service</div>
                                <div style="font-size: 11px; color: #6b7280;">Expiry: @(ViewBag.SingleItemExpiry ?? "N/A")</div>
                            </td>
                            <td class="text-center">$@Model.price.ToString("N2")</td>
                            <td class="text-center">@Model.qty_unit_type</td>
                            <td class="text-right" style="font-weight: 800;">$@((Model.price - Model.discount).ToString("N2"))</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- Bottom Section -->
        <div class="bottom-section">
            <div style="width: 50%;">
                <div style="font-weight: 800; font-size: 14px; margin-bottom: 10px;">Terms & Conditions</div>
                <div style="font-size: 11px; color: #6b7280; line-height: 1.5;">
                    Please make payment within 15 days of receiving this invoice. 
                    Thank you for choosing SATA TECHNOLOGIES for your business needs.
                </div>
                <div class="signature-box">
                    <div class="signature-line">Authorized Signature</div>
                </div>
            </div>
            <div class="summary-box">
                <div class="summary-row">
                    <span style="font-weight: 700; color: #6b7280;">Sub Total</span>
                    <span style="font-weight: 800; color: #111827;">$@subtotal.ToString("N2")</span>
                </div>
                <div class="summary-row">
                    <span style="font-weight: 700; color: #6b7280;">Discount</span>
                    <span style="font-weight: 800; color: #BC1823;">-$@discount.ToString("N2")</span>
                </div>
                <div class="summary-total">
                    <span>Grand Total</span>
                    <span>$@totalAmount.ToString("N2")</span>
                </div>
            </div>
        </div>


        <!-- Bottom Patterns -->
        <div class="bottom-pattern">
            <div class="shape-red-bottom"></div>
            <div class="shape-black-bottom-1"></div>
            <div class="shape-black-bottom-2"></div>
        </div>
        <div class="footer-branding">SATA E-Invoice System â€¢ Innovating the Future</div>
    </div>
</div>

<style>
    #invoiceViewWrapper {
        background: #f0f2f5;
        padding: 40px 20px;
        margin: -32px -16px -24px -16px;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        font-family: 'Montserrat', sans-serif;
    }

    .invoice-container {
        background: white;
        width: 100%;
        max-width: 210mm;
        min-height: 297mm;
        position: relative;
        box-shadow: 0 20px 50px rgba(0,0,0,0.1);
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    /* Top Geometric Patterns */
    .top-pattern {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 220px;
        z-index: 1;
    }

    .shape-red-top {
        position: absolute;
        top: 0;
        left: 0;
        width: 180px;
        height: 180px;
        background: #BC1823;
        clip-path: polygon(0 0, 100% 0, 0 100%);
        z-index: 2;
    }

    .shape-black-top-1 {
        position: absolute;
        top: 0;
        left: 80px;
        width: 150px;
        height: 150px;
        background: #1C2120;
        clip-path: polygon(0 0, 100% 0, 40% 100%);
        z-index: 1;
        opacity: 0.9;
    }

    .shape-black-top-2 {
        position: absolute;
        top: 0;
        left: 200px;
        width: 200px;
        height: 100px;
        background: #1C2120;
        clip-path: polygon(0 0, 100% 0, 60% 100%);
        z-index: 0;
        opacity: 0.8;
    }

    .header-content {
        position: relative;
        z-index: 10;
        padding: 40px 60px;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
    }

    .logo-box {
        background: white;
        padding: 10px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        border-radius: 4px;
        width: fit-content;
    }

    .logo-box img {
        height: 60px;
        width: auto;
    }

    .invoice-label {
        font-size: 40px;
        font-weight: 900;
        color: #BC1823;
        text-transform: uppercase;
        line-height: 1;
    }

    .invoice-no {
        font-size: 16px;
        font-weight: 700;
        color: #1C2120;
        text-align: right;
    }

    .details-section {
        padding: 0 60px 40px 60px;
        display: flex;
        justify-content: space-between;
        position: relative;
        z-index: 10;
    }

    .section-label {
        background: #BC1823;
        color: white;
        padding: 4px 15px;
        font-size: 12px;
        font-weight: 800;
        display: inline-block;
        margin-bottom: 15px;
        text-transform: uppercase;
    }

    .billing-name {
        font-size: 18px;
        font-weight: 800;
        color: #1C2120;
        margin-bottom: 5px;
    }

    .billing-details {
        font-size: 14px;
        color: #4b5563;
        line-height: 1.6;
    }

    .info-bar {
        padding: 0 60px 30px 60px;
        display: flex;
        gap: 40px;
        position: relative;
        z-index: 10;
    }

    .info-label {
        font-size: 11px;
        font-weight: 700;
        color: #9ca3af;
        text-transform: uppercase;
    }

    .info-value {
        font-size: 14px;
        font-weight: 800;
        color: #111827;
    }

    .status-badge {
        padding: 2px 10px;
        border-radius: 4px;
        color: white;
        font-size: 12px;
    }

    .items-section {
        padding: 0 60px;
        flex-grow: 1;
    }

    table {
        width: 100%;
        border-collapse: collapse;
    }

    thead tr { background: #BC1823; color: white; }
    th { padding: 8px 12px; text-align: left; font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; }
    td { padding: 10px 12px; border-bottom: 1px solid #f3f4f6; font-size: 13px; color: #4b5563; }
    .text-right { text-align: right; }
    .text-center { text-align: center; }

    .bottom-section {
        padding: 40px 60px;
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
        position: relative;
        z-index: 10;
    }

    .summary-box { width: 45%; }
    .summary-row { display: flex; justify-content: space-between; padding: 8px 0; font-size: 14px; }
    .summary-total {
        background: #BC1823;
        color: white;
        padding: 12px 24px;
        border-radius: 20px;
        margin-top: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 15px;
        font-weight: 800;
        font-size: 18px;
        box-shadow: 0 4px 10px rgba(188, 24, 35, 0.1);
    }

    .signature-line {
        border-top: 2px solid #111827;
        margin-top: 50px;
        padding-top: 10px;
        font-size: 12px;
        font-weight: 800;
        text-transform: uppercase;
    }

    .bottom-pattern {
        position: relative;
        height: 150px;
        width: 100%;
        margin-top: auto;
    }

    .shape-red-bottom {
        position: absolute;
        bottom: 0;
        left: 100px; /* Moved further left from 150px */
        width: 400px;
        height: 120px;
        background: #BC1823;
        clip-path: polygon(20% 0, 100% 100%, 0 100%);
        z-index: 2;
    }

    .shape-black-bottom-1 {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 300px;
        height: 150px;
        background: #1C2120;
        clip-path: polygon(0 0, 60% 100%, 0 100%);
        z-index: 1;
    }

    .shape-black-bottom-2 {
        position: absolute;
        bottom: 0;
        right: 0;
        width: 350px;
        height: 80px;
        background: #1C2120;
        clip-path: polygon(30% 0, 100% 0, 100% 100%, 0% 100%);
        z-index: 1;
    }

    .signature-box { 
        text-align: center; 
        width: 180px; 
        margin-top: 30px; /* Space from Terms & Conditions */
    }

    .footer-branding {
        position: absolute !important;
        bottom: 8px !important;
        right: 15px !important;
        color: white !important;
        font-size: 8px !important;
        font-weight: 800 !important;
        letter-spacing: 1.5px !important;
        text-transform: uppercase !important;
        z-index: 99 !important;
        display: block !important;
        text-align: right !important;
    }

    @@page {
        size: A4;
        margin: 0 !important;
    }

    @@media print {
        #invoiceViewWrapper { 
            visibility: visible !important;
            display: block !important;
            padding: 0 !important;
            margin: 0 !important;
        }
        
        .no-print, .sidebar, .top-bar, .toast-container { display: none !important; }
        
        * {
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
            color-adjust: exact !important;
        }

        html, body { 
            visibility: hidden; 
            margin: 0 !important; 
            padding: 0 !important;
            height: 297mm !important;
            width: 210mm !important;
            background: white !important;
            overflow: hidden !important;
            display: block !important;
        }

        #printableInvoice, #printableInvoice * { 
            visibility: visible; 
        }

        #printableInvoice { 
            position: fixed !important; 
            left: 0 !important; 
            top: 0 !important; 
            width: 210mm !important; 
            height: 297mm !important; /* Exact A4 height */
            margin: 0 !important; 
            padding: 0 !important;
            box-shadow: none !important;
            border: none !important;
            box-sizing: border-box !important;
            border-radius: 0 !important;
            display: block !important;
            overflow: hidden !important;
            page-break-after: avoid !important;
            transform: none !important; /* Remove scaling to fill paper edges */
            transform-origin: top left !important;
            z-index: 9999 !important;
        }

        .bottom-pattern {
            position: absolute !important;
            bottom: -2px !important; 
            right: -2px !important; 
            left: -2px !important;  
            display: block !important;
            width: calc(100% + 4px) !important;
        }

        .shape-black-bottom-2 {
            right: -2px !important;
            bottom: -2px !important;
            width: 252px !important;
        }

        .footer-branding {
            position: absolute !important;
            bottom: 8px !important;
            right: 15px !important;
            font-size: 8px !important;
            display: block !important;
            z-index: 10000 !important;
            color: white !important;
            white-space: nowrap !important;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
            text-transform: uppercase !important;
            letter-spacing: 1.5px !important;
            text-align: right !important;
        }
        
        .items-section {
            padding-bottom: 160px !important;
        }

        .top-pattern, .bottom-pattern {
            display: block !important;
        }
    }
</style>
