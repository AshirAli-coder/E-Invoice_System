@using System.Text.Json
@model E_Invoice_system.Models.invoices

@{
    var subtotal = Model.price;
    var discount = Model.discount;
    var totalAmount = Model.total_price;

    var isMultiItem = false;
    List<Dictionary<string, object>> items = new List<Dictionary<string, object>>();

    try
    {
        if (!string.IsNullOrEmpty(Model.prod_name_service) && Model.prod_name_service.Trim().StartsWith("["))
        {
            var jsonElements = JsonSerializer.Deserialize<List<Dictionary<string, JsonElement>>>(Model.prod_name_service);
            if (jsonElements != null && jsonElements.Count > 0)
            {
                isMultiItem = true;
                foreach (var item in jsonElements)
                {
                    var newItem = new Dictionary<string, object>();
                    foreach (var kvp in item)
                    {
                        if (kvp.Value.ValueKind == JsonValueKind.Number)
                            newItem[kvp.Key] = kvp.Value.GetDecimal();
                        else if (kvp.Value.ValueKind == JsonValueKind.String)
                            newItem[kvp.Key] = kvp.Value.GetString() ?? "";
                        else
                            newItem[kvp.Key] = kvp.Value.ToString();
                    }
                    items.Add(newItem);
                }
                if (subtotal == 0 && items.Any())
                {
                    subtotal = items.Sum(i => (decimal)i["price"] * (decimal)i["qty"]);
                }
            }
        }
    }
    catch { isMultiItem = false; }
}

<div class="no-print" style="display: flex; gap: 1rem; margin-bottom: 2rem; justify-content: flex-end; padding: 0 20px;">
    <button onclick="window.print()" class="btn-primary" style="background: #BC1823; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 6px; cursor: pointer; font-weight: 800; display: flex; align-items: center; gap: 8px;">
        <i class="ph-printer-bold"></i> PRINT INVOICE
    </button>
    <a asp-action="Index" class="btn-primary" style="background: #111827; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 6px; text-decoration: none; font-weight: 700;">
        <i class="ph-arrow-left"></i> BACK
    </a>
</div>

<div id="invoiceViewWrapper">
    <div class="invoice-container" id="printableInvoice">
        <!-- Top Patterns -->
        <div class="top-pattern">
            <div class="shape-red-top"></div>
            <div class="shape-black-top-1"></div>
            <div class="shape-black-top-2"></div>
        </div>

        <div class="header-content">
            <div class="logo-section">
                <div class="logo-box">
                    <img src="/images/sata-logo.png" alt="SATA Logo" />
                </div>
            </div>
            <div class="invoice-title-section">
                <div class="invoice-label">Invoice</div>
                <div class="invoice-no"># @(Model.invoice_no ?? Model.id.ToString())</div>
            </div>
        </div>

        <!-- Billing Section -->
        <div class="details-section">
            <div class="billing-box">
                <div class="section-label">Invoice To:</div>
                <div class="billing-details">
                    <div class="billing-name">@Model.customer_name</div>
                    <div>@Model.customer_address</div>
                    <div>Phone: @Model.customer_contact</div>
                </div>
            </div>
            <div class="billing-box" style="text-align: right;">
                <div class="section-label">Invoice From:</div>
                <div class="billing-details">
                    <div class="billing-name">@Model.seller_name</div>
                    <div>@Model.seller_address</div>
                    <div>Phone: @Model.seller_contact</div>
                    <div style="font-weight: 800; color: #111827; margin-top: 5px;">Date: @Model.date.ToString("dd MMM yyyy")</div>
                </div>
            </div>
        </div>

        <div class="info-bar">
            <div class="info-item">
                <div class="info-label">Status</div>
                <div class="info-value"><span class="status-badge" style="background: @(Model.status == "Paid" ? "#10b981" : "#BC1823")">@(Model.status ?? "PENDING")</span></div>
            </div>
            <div class="info-item">
                <div class="info-label">Payment Method</div>
                <div class="info-value">@(Model.payment ?? "Not Specified")</div>
            </div>
        </div>

        <!-- Items Table -->
        <div class="items-section">
            <table>
                <thead>
                    <tr>
                        <th width="50%">Products/Services</th>
                        <th class="text-center">Price</th>
                        <th class="text-center">Qty</th>
                        <th class="text-right">Total</th>
                    </tr>
                </thead>
                <tbody>
                    @if (isMultiItem) {
                        foreach(var item in items) {
                            <tr>
                                <td>
                                    <div style="font-weight: 800;">@item["name"]</div>
                                    <div style="font-size: 11px; color: #6b7280;">Expiry: @(item.ContainsKey("expiryDate") ? item["expiryDate"] : "N/A")</div>
                                </td>
                                <td class="text-center">$@(((decimal)item["price"]).ToString("N2"))</td>
                                <td class="text-center">@item["qty"]</td>
                                <td class="text-right" style="font-weight: 800;">$@(((decimal)item["total"]).ToString("N2"))</td>
                            </tr>
                        }
                    } else {
                        <tr>
                            <td>
                                <div style="font-weight: 800;">@Model.prod_name_service</div>
                                <div style="font-size: 11px; color: #6b7280;">Expiry: @(ViewBag.SingleItemExpiry ?? "N/A")</div>
                            </td>
                            <td class="text-center">$@Model.price.ToString("N2")</td>
                            <td class="text-center">@Model.qty_unit_type</td>
                            <td class="text-right" style="font-weight: 800;">$@((Model.price - Model.discount).ToString("N2"))</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- Bottom Section -->
        <div class="bottom-section">
            <div style="width: 50%;">
                <div style="font-weight: 800; font-size: 14px; margin-bottom: 10px;">Terms & Conditions</div>
                <div style="font-size: 11px; color: #6b7280; line-height: 1.5;">
                    Please make payment within 15 days of receiving this invoice. 
                    Thank you for choosing SATA TECHNOLOGIES for your business needs.
                </div>
                <div class="signature-box">
                    <div class="signature-line">Authorized Signature</div>
                </div>
            </div>
            <div class="summary-box">
                <div class="summary-row">
                    <span style="font-weight: 700; color: #6b7280;">Sub Total</span>
                    <span style="font-weight: 800; color: #111827;">$@subtotal.ToString("N2")</span>
                </div>
                <div class="summary-row">
                    <span style="font-weight: 700; color: #6b7280;">Discount</span>
                    <span style="font-weight: 800; color: #BC1823;">$@discount.ToString("N2")</span>
                </div>
                <div class="summary-total">
                    <span>Grand Total</span>
                    <span>$@totalAmount.ToString("N2")</span>
                </div>
            </div>
        </div>


        <!-- Bottom Patterns -->
        <div class="bottom-pattern">
            <div class="shape-red-bottom"></div>
            <div class="shape-black-bottom-1"></div>
            <div class="shape-black-bottom-2"></div>
        </div>
        <div class="footer-branding">SATA E-Invoice System â€¢Innovating the Future</div>
    </div>
</div>


