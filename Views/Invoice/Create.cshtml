@model E_Invoice_system.Models.invoices
@{
    var buyers = ViewBag.Buyers as List<E_Invoice_system.Models.buyers>;
    var sellers = ViewBag.Sellers as List<E_Invoice_system.Models.Sellers>;
}

<div class="card" style="max-width: 1400px; margin: 2rem auto; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); border: none; border-radius: 12px;">
    <div class="card-header">
        <div class="card-title">Generate New Invoice</div>
    </div>
    
    <form asp-action="Create" method="post" style="padding: 1rem;">
        @Html.AntiForgeryToken()

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
            <div>
                <label style="display: block; font-size: 0.85rem; font-weight: 600; color: var(--text-muted); margin-bottom: 0.75rem;">Select Buyer</label>
                <select asp-for="buyer_name" class="form-control" required id="buyerSelect" style="width: 100%; padding: 0.8rem; border-radius: 8px; border: 1px solid var(--border); background: white; box-sizing: border-box; display: block; font-family: inherit; outline: none;">
                    <option value="">-- Choose Buyer --</option>
                    @foreach (var b in buyers)
                    {
                        <option value="@b.name" data-address="@b.address" data-contact="@b.contact">@b.name</option>
                    }
                </select>
            </div>
            <div>
                <label style="display: block; font-size: 0.85rem; font-weight: 600; color: var(--text-muted); margin-bottom: 0.75rem;">Invoice Number</label>
                <input asp-for="invoice_no" class="form-control" style="width: 100%; padding: 0.8rem; border-radius: 8px; border: 1px solid var(--border);" placeholder="INV-0001 (Auto)" />
            </div>
            <div>
                <label style="display: block; font-size: 0.85rem; font-weight: 600; color: var(--text-muted); margin-bottom: 0.75rem;">Buyer Contact</label>
                <input asp-for="buyer_contact" id="buyerContact" class="form-control" style="width: 100%; padding: 0.8rem; border-radius: 8px; border: 1px solid var(--border);" placeholder="Buyer Contact" />
            </div>
            <div>
                <label style="display: block; font-size: 0.85rem; font-weight: 600; color: var(--text-muted); margin-bottom: 0.75rem;">Buyer Address</label>
                <input asp-for="buyer_address" id="buyerAddress" class="form-control" style="width: 100%; padding: 0.8rem; border-radius: 8px; border: 1px solid var(--border);" placeholder="Buyer Address" />
            </div>
        </div>

        <!-- Sales Selection Section -->
        <div id="salesListContainer" style="display: none; background: #fffbff; border: 1px solid #fbcfe8; border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h4 style="margin: 0; font-size: 0.9rem; color: #9d174d; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="ph-shopping-cart" style="font-size: 1.2rem;"></i> 
                    Check Previous Sales for this Buyer
                </h4>
                <button type="button" onclick="addSelectedSales()" class="btn-primary" style="background: #9d174d; border: none; padding: 0.5rem 1rem; font-size: 0.8rem;">
                    Add Selected to Invoice
                </button>
            </div>
            <div>
                <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                    <thead>
                        <tr style="text-align: left; border-bottom: 1px solid #fbcfe8;">
                            <th style="padding: 0.5rem; width: 40px;"></th>
                            <th style="padding: 0.5rem; width: 120px; white-space: nowrap;">Date</th>
                            <th style="padding: 0.5rem;">Product / Service</th>
                            <th style="padding: 0.5rem; width: 100px;">Qty/Unit</th>
                            <th style="padding: 0.5rem; width: 90px;">Price</th>
                            <th style="padding: 0.5rem; width: 90px;">Discount</th>
                            <th style="padding: 0.5rem; width: 130px; white-space: nowrap;">Expiry Date</th>
                            <th style="padding: 0.5rem; width: 90px;">Status</th>
                            <th style="padding: 0.5rem; width: 100px;">Total</th>
                        </tr>
                    </thead>
                    <tbody id="salesListBody">
                        <!-- Sales will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>

        <hr style="border: 0; border-top: 1px solid var(--border); margin: 2rem 0;" />
        
        <!-- Items Table -->
        <table style="width: 100%; border-collapse: separate; border-spacing: 0; margin-bottom: 2rem; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);">
            <thead>
                <tr style="background: #f8fafc; text-align: left;">
                    <th style="padding: 1rem; font-size: 0.85rem; font-weight: 600; width: 35%;">Product/Service</th>
                    <th style="padding: 1rem; font-size: 0.85rem; font-weight: 600; width: 15%;">Qty/Unit_type</th>
                    <th style="padding: 1rem; font-size: 0.85rem; font-weight: 600; width: 16%; white-space: nowrap;">Expiry Date</th>
                    <th style="padding: 1rem; font-size: 0.85rem; font-weight: 600; width: 11%;">Price</th>
                    <th style="padding: 1rem; font-size: 0.85rem; font-weight: 600; width: 11%;">Discount</th>
                    <th style="padding: 1rem; font-size: 0.85rem; font-weight: 600; width: 11%;">Total</th>
                    <th style="padding: 1rem; width: 60px;"></th>
                </tr>
            </thead>
            <tbody id="itemsTableBody">
                <!-- Items added from sales will be listed here -->
            </tbody>
        </table>

        <!-- Hidden Fields for Storage -->
        <input type="hidden" asp-for="prod_name_service" id="prodNameServiceHidden" />
        <input type="hidden" asp-for="qty_unit_type" id="qtyUnitTypeHidden" />
        <input type="hidden" asp-for="total_price" id="totalPriceInput" />
        <input type="hidden" asp-for="price" id="priceInputHidden" />
        <!-- We use discount column to store total discount of the invoice -->
        <input type="hidden" asp-for="discount" id="totalDiscountInput" />


        <hr style="border: 0; border-top: 1px solid var(--border); margin: 2rem 0;" />

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
            <div style="grid-column: span 2;">
                <label style="display: block; font-size: 0.85rem; font-weight: 600; color: var(--text-muted); margin-bottom: 0.75rem;">Seller Name</label>
                <select asp-for="seller_name" class="form-control" required id="sellerSelect" style="width: 100%; padding: 0.8rem; border-radius: 8px; border: 1px solid var(--border); background: white; box-sizing: border-box; display: block; font-family: inherit; outline: none; height: 82px;">
                    <option value="">-- Select Seller --</option>
                    @foreach (var s in sellers)
                    {
                        <option value="SATA Technologies" data-contact="@s.contact" data-address="@s.address">SATA Technologies (@s.email)</option>
                    }
                </select>
            </div>
            <div>
                <label style="display: block; font-size: 0.85rem; font-weight: 600; color: var(--text-muted); margin-bottom: 0.75rem;">Payment Method</label>
                <select asp-for="payment" class="form-control" style="width: 100%; padding: 0.8rem; border-radius: 8px; border: 1px solid var(--border); background: white; box-sizing: border-box; display: block; font-family: inherit; outline: none;">
                    <option value="Cash">Cash</option>
                    <option value="Bank Transfer">Bank Transfer</option>
                    <option value="Online">Online</option>
                    <option value="Credit">Credit</option>
                </select>
            </div>
            <div>
                <label style="display: block; font-size: 0.85rem; font-weight: 600; color: var(--text-muted); margin-bottom: 0.75rem;">Invoice Status</label>
                <select asp-for="status" class="form-control" style="width: 100%; padding: 0.8rem; border-radius: 8px; border: 1px solid var(--border); background: white; box-sizing: border-box; display: block; font-family: inherit; outline: none;">
                    <option value="Pending">Pending</option>
                    <option value="Paid">Paid</option>
                    <option value="Cancelled">Cancelled</option>
                </select>
            </div>
            <div style="grid-column: span 2;">
                <label style="display: block; font-size: 0.85rem; font-weight: 600; color: var(--text-muted); margin-bottom: 0.75rem;">Seller Contact</label>
                <input asp-for="seller_contact" id="sellerContact" placeholder="Seller Contact" style="width: 100%; padding: 0.8rem; border-radius: 8px; border: 1px solid var(--border);" />
            </div>
            <div style="grid-column: span 2;">
                <label style="display: block; font-size: 0.85rem; font-weight: 600; color: var(--text-muted); margin-bottom: 0.75rem;">Seller Address</label>
                <textarea asp-for="seller_address" id="sellerAddress" placeholder="Seller Address" style="width: 100%; padding: 0.8rem; border-radius: 8px; border: 1px solid var(--border); resize: vertical;" rows="2"></textarea>
            </div>
        </div>


        <div style="display: flex; gap: 1rem; margin-top: 3rem; justify-content: flex-end;">
            <button type="submit" class="btn-primary" style="padding: 0.8rem 2rem; font-weight: 600;">Create Invoice</button>
            <a asp-action="Index" class="btn-primary" style="background: #fff; color: var(--text); border: 1px solid var(--border); padding: 0.8rem 2rem; font-weight: 600;">Cancel</a>
        </div>
    </form>
</div>

<script>
    let invoiceItems = [];
    let currentBuyerSales = [];
    const products = @Html.Raw(Json.Serialize(ViewBag.Products));

    document.getElementById('buyerSelect').addEventListener('change', function() {
        const buyerName = this.value;
        const container = document.getElementById('salesListContainer');
        const body = document.getElementById('salesListBody');
        
        if (!buyerName) {
            container.style.display = 'none';
            document.getElementById('buyerContact').value = '';
            document.getElementById('buyerAddress').value = '';
            return;
        }

        const option = this.options[this.selectedIndex];
        document.getElementById('buyerContact').value = option.getAttribute('data-contact') || '';
        document.getElementById('buyerAddress').value = option.getAttribute('data-address') || '';


        fetch(`/Invoice/GetSalesByBuyer?buyerName=${encodeURIComponent(buyerName)}`)
            .then(res => res.json())
            .then(data => {
                if (data.success && data.sales.length > 0) {
                    currentBuyerSales = data.sales;
                    body.innerHTML = '';
                    data.sales.forEach((sale, index) => {
                        const tr = document.createElement('tr');
                        tr.style.borderBottom = '1px solid #fecaca';
                        tr.innerHTML = `
                            <td style="padding: 0.5rem; text-align: center;">
                                <input type="checkbox" class="sale-checkbox" data-index="${index}" style="width: 16px; height: 16px;">
                            </td>
                            <td style="padding: 0.5rem; width: 120px; white-space: nowrap;">${sale.date}</td>
                            <td style="padding: 0.5rem; font-weight: 600;">${sale.prod_name_service}</td>
                            <td style="padding: 0.5rem; width: 100px;">${sale.qty_unit_type}</td>
                            <td style="padding: 0.5rem; width: 90px;">$${sale.price.toFixed(2)}</td>
                            <td style="padding: 0.5rem; width: 90px;">${sale.discount > 0 ? '$' + sale.discount.toFixed(2) : '-'}</td>
                            <td style="padding: 0.5rem; width: 130px; white-space: nowrap; color: var(--text-muted);">${sale.expiryDate}</td>
                            <td style="padding: 0.5rem; width: 90px;">
                                <span style="padding: 0.2rem 0.5rem; background: #fce7f3; color: #be185d; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">${sale.status}</span>
                            </td>
                            <td style="padding: 0.5rem; width: 100px; font-weight: 600; color: var(--primary);">$${sale.total_price.toFixed(2)}</td>
                        `;
                        body.appendChild(tr);
                    });
                    container.style.display = 'block';
                } else {
                    container.style.display = 'none';
                }
            });
    });

    function addSelectedSales() {
        const checkboxes = document.querySelectorAll('.sale-checkbox:checked');
        checkboxes.forEach(cb => {
            const index = cb.dataset.index;
            const sale = currentBuyerSales[index];
            
            const item = {
                id: 0, // Not a specific product ID if it's from a sale record
                name: sale.prod_name_service,
                // unit: sale.qty_unit_type,
                qty: parseFloat(sale.qty_unit_type.split(' ')[0]) || 1,
                price: sale.price,
                discount: sale.discount,
                expiry: sale.expiryDate, // Capture expiry date
                total: sale.total_price
            };
            
            invoiceItems.push(item);
            cb.checked = false;
        });
        
        renderItems();
        updateTotals();
    }

    function removeItem(index) {
        invoiceItems.splice(index, 1);
        renderItems();
        updateTotals();
    }

    function renderItems() {
        const tbody = document.getElementById('itemsTableBody');
        tbody.innerHTML = '';

        invoiceItems.forEach((item, index) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="padding: 0.75rem;">${item.name}</td>
                <td style="padding: 0.75rem;">${item.qty} ${item.unit || ''}</td>
                <td style="padding: 0.75rem; white-space: nowrap; color: var(--text-muted);">${item.expiry || ''}</td>
                <td style="padding: 0.75rem;">$${item.price.toFixed(2)}</td>
                <td style="padding: 0.75rem;">$${item.discount.toFixed(2)}</td>
                <td style="padding: 0.75rem; font-weight: bold;">$${item.total.toFixed(2)}</td>
                <td style="padding: 0.75rem; text-align: center;">
                    <button type="button" onclick="removeItem(${index})" style="background: #fee2e2; color: #ef4444; border: 1px solid #fecaca; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer;">
                        Remove
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });

        // Update hidden field with JSON data
        document.getElementById('prodNameServiceHidden').value = JSON.stringify(invoiceItems);
    }

    function updateTotals() {
        const total = invoiceItems.reduce((sum, item) => sum + item.total, 0);
        const totalDiscount = invoiceItems.reduce((sum, item) => sum + item.discount, 0);
        const subtotal = invoiceItems.reduce((sum, item) => sum + (item.price * item.qty), 0);
        
        document.getElementById('totalPriceInput').value = total.toFixed(2); // Net Total
        document.getElementById('totalDiscountInput').value = totalDiscount.toFixed(2);
        document.getElementById('priceInputHidden').value = subtotal.toFixed(2); // Gross Subtotal
        
        // Update summary text for qty_unit_type column
        document.getElementById('qtyUnitTypeHidden').value = `${invoiceItems.length} Items`;
    }

    document.getElementById('sellerSelect').addEventListener('change', function() {
        const option = this.options[this.selectedIndex];
        document.getElementById('sellerContact').value = option.getAttribute('data-contact') || '';
        document.getElementById('sellerAddress').value = option.getAttribute('data-address') || '';
    });
</script>
