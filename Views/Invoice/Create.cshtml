@model E_Invoice_system.Models.invoices
@{
    var buyers = ViewBag.Buyers as List<E_Invoice_system.Models.buyers>;
    var sellers = ViewBag.Sellers as List<E_Invoice_system.Models.Sellers>;
}

<div class="dashboard-panel">
    <div class="page-header">
        <h1 class="page-title-large">
            <i class="ph-file-plus" style="color: var(--primary);"></i>
            Generate New Invoice
        </h1>
        <a asp-action="Index" class="btn-secondary">
            <i class="ph-arrow-left"></i> Back to List
        </a>
    </div>
    
    <div class="form-wrapper">
        <form asp-action="Create" method="post">
            @Html.AntiForgeryToken()

            <!-- Section 1: Seller Information -->
            <div class="form-section">
                <div class="form-section-header">
                    <h3 class="form-section-title">
                        <i class="ph-buildings" style="color: var(--primary);"></i>
                        Seller Information (Self)
                    </h3>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Company Name</label>
                        <select asp-for="seller_name" class="form-control" id="sellerSelect" required>
                            <option value="">-- Select Seller --</option>
                            @if (sellers != null)
                            {
                                foreach (var s in sellers)
                                {
                                    <option value="@s.name" data-address="@s.address" data-contact="@s.contact">@s.name</option>
                                }
                            }
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Invoice Date</label>
                        <input asp-for="date" class="form-control" type="date" value="@DateTime.Now.ToString("yyyy-MM-dd")" />
                    </div>
                    <div class="form-group">
                        <label class="form-label">Seller Contact</label>
                        <input asp-for="seller_contact" id="sellerContactTop" class="form-control" placeholder="Contact number" />
                    </div>
                    <div class="form-group">
                        <label class="form-label">Seller Address</label>
                        <input asp-for="seller_address" id="sellerAddressTop" class="form-control" placeholder="Office address" />
                    </div>
                </div>
            </div>


            <!-- Section 2: Buyer Information -->
            <div class="form-section">
                <div class="form-section-header">
                    <h3 class="form-section-title">
                        <i class="ph-user" style="color: var(--primary);"></i>
                        Buyer Information
                    </h3>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Select Buyer</label>
                        <select asp-for="buyer_name" class="form-control" required id="buyerSelect">
                            <option value="">-- Choose Buyer --</option>
                            @foreach (var b in buyers)
                            {
                                <option value="@b.name" data-address="@b.address" data-contact="@b.contact">@b.name</option>
                            }
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Invoice Number</label>
                        <input asp-for="invoice_no" class="form-control" placeholder="INV-0001 (Auto)" />
                    </div>
                    <div class="form-group">
                        <label class="form-label">Buyer Contact</label>
                        <input asp-for="buyer_contact" id="buyerContact" class="form-control" placeholder="Buyer Contact" />
                    </div>
                    <div class="form-group">
                        <label class="form-label">Buyer Address</label>
                        <input asp-for="buyer_address" id="buyerAddress" class="form-control" placeholder="Buyer Address" />
                    </div>
                </div>
            </div>

            <!-- Section 3: Line Items & Totals -->
            <div class="form-section">
                <div class="form-section-header">
                    <h3 class="form-section-title">
                        <i class="ph-list-bullets" style="color: var(--primary);"></i>
                        Invoice Line Items
                    </h3>
                </div>

                <!-- Sales Selection Section -->
                <div id="salesListContainer" style="display: none; background: #fffbff; border: 1px dotted var(--primary); border-radius: 8px; padding: 1.5rem; margin-bottom: 2rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h4 style="margin: 0; font-size: 1rem; color: var(--primary); display: flex; align-items: center; gap: 0.5rem;">
                            <i class="ph-shopping-cart-simple" style="font-size: 1.25rem;"></i> 
                            Check Previous Sales for this Buyer
                        </h4>
                        <button type="button" onclick="addSelectedSales()" class="btn-primary" style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                            Add Selected Items
                        </button>
                    </div>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                            <thead>
                                <tr style="text-align: left; border-bottom: 1px solid var(--border); color: var(--text-muted);">
                                    <th style="padding: 0.75rem 0.5rem; width: 40px;"></th>
                                    <th style="padding: 0.75rem 0.5rem;">Date</th>
                                    <th style="padding: 0.75rem 0.5rem;">Product / Service</th>
                                    <th style="padding: 0.75rem 0.5rem; width: 80px;">Qty</th>
                                    <th style="padding: 0.75rem 0.5rem; width: 100px;">Price</th>
                                    <th style="padding: 0.75rem 0.5rem; width: 100px;">Discount</th>
                                    <th style="padding: 0.75rem 0.5rem;">Expiry</th>
                                    <th style="padding: 0.75rem 0.5rem; width: 100px;">Total</th>
                                </tr>
                            </thead>
                            <tbody id="salesListBody">
                                <!-- Sales will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Items Table -->
                <div style="overflow-x: auto; margin-bottom: 1.5rem;">
                    <table style="width: 100%; border-collapse: separate; border-spacing: 0; border: 1px solid var(--border); border-radius: 12px; overflow: hidden;">
                        <thead>
                            <tr style="background: #f8fafc; text-align: left;">
                                <th style="padding: 1rem; font-size: 0.875rem; font-weight: 700; color: var(--text-muted); width: 35%;">Product/Service</th>
                                <th style="padding: 1rem; font-size: 0.875rem; font-weight: 700; color: var(--text-muted); width: 15%;">Qty/Unit</th>
                                <th style="padding: 1rem; font-size: 0.875rem; font-weight: 700; color: var(--text-muted); width: 16%;">Expiry</th>
                                <th style="padding: 1rem; font-size: 0.875rem; font-weight: 700; color: var(--text-muted); width: 11%;">Price</th>
                                <th style="padding: 1rem; font-size: 0.875rem; font-weight: 700; color: var(--text-muted); width: 11%;">Discount</th>
                                <th style="padding: 1rem; font-size: 0.875rem; font-weight: 700; color: var(--text-muted); width: 11%;">Total</th>
                                <th style="padding: 1rem; width: 80px;"></th>
                            </tr>
                        </thead>
                        <tbody id="itemsTableBody">
                            <!-- Items added from sales will be listed here -->
                        </tbody>
                    </table>
                </div>

                <!-- Hidden Fields for Storage -->
                <input type="hidden" asp-for="prod_name_service" id="prodNameServiceHidden" />
                <input type="hidden" asp-for="qty_unit_type" id="qtyUnitTypeHidden" />
                <input type="hidden" asp-for="total_price" id="totalPriceInput" />
                <input type="hidden" asp-for="price" id="priceInputHidden" />
                <input type="hidden" asp-for="discount" id="totalDiscountInput" />

                <!-- Section 4: Finalize & Payment -->
                <div style="padding-top: 1.5rem; border-top: 1px solid var(--border);">
                    <div class="form-grid" style="grid-template-columns: 1fr 1fr; max-width: 800px;">
                        <div class="form-group">
                            <label class="form-label">Invoice Status</label>
                            <select asp-for="status" class="form-control">
                                <option value="Pending">Pending</option>
                                <option value="Paid">Paid</option>
                                <option value="Cancelled">Cancelled</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Payment Method</label>
                            <select asp-for="payment" class="form-control">
                                <option value="Cash">Cash</option>
                                <option value="Bank Transfer">Bank Transfer</option>
                                <option value="Online">Online</option>
                                <option value="Credit">Credit</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-actions-sticky">
                <a asp-action="Index" class="btn-secondary">
                    Cancel
                </a>
                <button type="submit" class="btn-primary">
                    <i class="ph-check-circle"></i>
                    Generate Invoice
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    let invoiceItems = [];
    let currentBuyerSales = [];
    const products = @Html.Raw(Json.Serialize(ViewBag.Products));

    document.getElementById('sellerSelect').addEventListener('change', function() {
        const option = this.options[this.selectedIndex];
        document.getElementById('sellerContactTop').value = option.getAttribute('data-contact') || '';
        document.getElementById('sellerAddressTop').value = option.getAttribute('data-address') || '';
    });

    document.getElementById('buyerSelect').addEventListener('change', function() {
        const buyerName = this.value;
        const container = document.getElementById('salesListContainer');
        const body = document.getElementById('salesListBody');
        
        if (!buyerName) {
            container.style.display = 'none';
            document.getElementById('buyerContact').value = '';
            document.getElementById('buyerAddress').value = '';
            return;
        }

        const option = this.options[this.selectedIndex];
        document.getElementById('buyerContact').value = option.getAttribute('data-contact') || '';
        document.getElementById('buyerAddress').value = option.getAttribute('data-address') || '';


        fetch(`/Invoice/GetSalesByBuyer?buyerName=${encodeURIComponent(buyerName)}`)
            .then(res => res.json())
            .then(data => {
                if (data.success && data.sales.length > 0) {
                    currentBuyerSales = data.sales;
                    body.innerHTML = '';
                    data.sales.forEach((sale, index) => {
                        const tr = document.createElement('tr');
                        tr.style.borderBottom = '1px solid #fecaca';
                        tr.innerHTML = `
                            <td style="padding: 0.4rem; text-align: center;">
                                <input type="checkbox" class="sale-checkbox" data-index="${index}" style="width: 14px; height: 14px;">
                            </td>
                            <td style="padding: 0.4rem; width: 100px; white-space: nowrap;">${sale.date}</td>
                            <td style="padding: 0.4rem; font-weight: 600;">${sale.prod_name_service}</td>
                            <td style="padding: 0.4rem; width: 80px;">${sale.qty_unit_type}</td>
                            <td style="padding: 0.4rem; width: 80px;">$${sale.price.toFixed(2)}</td>
                            <td style="padding: 0.75rem;">${sale.discount > 0 ? '$' + sale.discount.toFixed(2) : '$0.00'}</td>
                            <td style="padding: 0.4rem; width: 100px; white-space: nowrap; color: var(--text-muted);">${sale.expiryDate}</td>
                            <td style="padding: 0.4rem; width: 80px;">
                                <span style="padding: 0.1rem 0.4rem; background: #fce7f3; color: #be185d; border-radius: 8px; font-size: 0.75rem; font-weight: 600;">${sale.status}</span>
                            </td>
                            <td style="padding: 0.4rem; width: 90px; font-weight: 600; color: var(--primary);">$${sale.total_price.toFixed(2)}</td>
                        `;
                        body.appendChild(tr);
                    });
                    container.style.display = 'block';
                } else {
                    container.style.display = 'none';
                }
            });
    });

    function addSelectedSales() {
        const checkboxes = document.querySelectorAll('.sale-checkbox:checked');
        checkboxes.forEach(cb => {
            const index = cb.dataset.index;
            const sale = currentBuyerSales[index];
            
            const item = {
                id: 0, // Not a specific product ID if it's from a sale record
                name: sale.prod_name_service,
                // unit: sale.qty_unit_type,
                qty: parseFloat(sale.qty_unit_type.split(' ')[0]) || 1,
                price: sale.price,
                discount: sale.discount,
                expiryDate: sale.expiryDate, // Capture expiry date
                total: sale.total_price
            };
            
            invoiceItems.push(item);
            cb.checked = false;
        });
        
        renderItems();
        updateTotals();
    }

    function removeItem(index) {
        invoiceItems.splice(index, 1);
        renderItems();
        updateTotals();
    }

    function renderItems() {
        const tbody = document.getElementById('itemsTableBody');
        tbody.innerHTML = '';

        invoiceItems.forEach((item, index) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="padding: 0.5rem;">${item.name}</td>
                <td style="padding: 0.5rem;">${item.qty} ${item.unit || ''}</td>
                <td style="padding: 0.5rem; white-space: nowrap; color: var(--text-muted);">${item.expiry || ''}</td>
                <td style="padding: 0.5rem;">$${item.price.toFixed(2)}</td>
                <td style="padding: 0.5rem;">$${item.discount.toFixed(2)}</td>
                <td style="padding: 0.5rem; font-weight: bold;">$${item.total.toFixed(2)}</td>
                <td style="padding: 0.5rem; text-align: center;">
                    <button type="button" onclick="removeItem(${index})" style="background: #fee2e2; color: #ef4444; border: 1px solid #fecaca; padding: 0.2rem 0.4rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                        Remove
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });

        // Update hidden field with JSON data
        document.getElementById('prodNameServiceHidden').value = JSON.stringify(invoiceItems);
    }

    function updateTotals() {
        const total = invoiceItems.reduce((sum, item) => sum + item.total, 0);
        const totalDiscount = invoiceItems.reduce((sum, item) => sum + item.discount, 0);
        const subtotal = invoiceItems.reduce((sum, item) => sum + (item.price * item.qty), 0);
        
        document.getElementById('totalPriceInput').value = total.toFixed(2); // Net Total
        document.getElementById('totalDiscountInput').value = totalDiscount.toFixed(2);
        document.getElementById('priceInputHidden').value = subtotal.toFixed(2); // Gross Subtotal
        
        // Update summary text for qty_unit_type column
        document.getElementById('qtyUnitTypeHidden').value = `${invoiceItems.length} Items`;
    }

</script>
