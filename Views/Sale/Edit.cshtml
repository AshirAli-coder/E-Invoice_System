@model E_Invoice_system.Models.Sale

<div class="card" style="max-width: 900px; margin: 2rem auto; padding: 2rem;">

    <form asp-action="Edit" method="post">
        @Html.AntiForgeryToken()
        <input type="hidden" asp-for="id" />
        <input type="hidden" asp-for="date" />

        <!-- Header -->
        <div style="margin-bottom: 1.5rem;">
            <h2 class="card-title" style="display: flex; align-items: center; gap: 0.5rem; font-size: 1.4rem;">
                <i class="ph-receipt" style="color: var(--primary); font-size: 1.6rem;"></i> Edit Sale
            </h2>
            <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 0.25rem;">Update details for this sale transaction below.</p>
        </div>

        <!-- Buyer & Payment Info -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
            <div>
                <input asp-for="buyer_name" class="form-control" placeholder="Buyer Name"
                       style="padding: 0.7rem; border-radius: 12px; border: 1px solid var(--border);" />
                <span asp-validation-for="buyer_name" class="text-danger" style="font-size: 0.7rem;"></span>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                <select asp-for="payment_method" class="form-control"
                        style="padding: 0.7rem; border-radius: 12px; border: 1px solid var(--border); background: var(--white);">
                    <option value="">Payment Method</option>
                    <option value="Cash">Cash</option>
                    <option value="Card">Card</option>
                    <option value="Bank Transfer">Bank Transfer</option>
                    <option value="Mobile Payment">Mobile Payment</option>
                </select>
                <span asp-validation-for="payment_method" class="text-danger" style="font-size: 0.7rem;"></span>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                <select asp-for="status" class="form-control"
                        style="padding: 0.7rem; border-radius: 12px; border: 1px solid var(--border); background: var(--white);">
                    <option value="">Status</option>
                    <option value="Paid">Paid</option>
                    <option value="Pending">Pending</option>
                    <option value="Cancelled">Cancelled</option>
                </select>
                <span asp-validation-for="status" class="text-danger" style="font-size: 0.7rem;"></span>
            </div>
        </div>

        <!-- Product Info -->
        <div style="background: var(--bg-light); border: 1px solid var(--border); border-radius: 14px; padding: 1.5rem; margin-bottom: 1.5rem;">
            <h3 style="font-weight: 700; color: var(--text); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; font-size: 1rem;">
                <i class="ph-package" style="color: var(--primary);"></i> Product Information
            </h3>

            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div>
                    <select id="productSelect" class="form-control"
                            style="padding: 0.7rem; border-radius: 12px; border: 1px solid var(--border); background: var(--white); width: 100%;">
                        <option value="">Select a product...</option>
                        @foreach (var p in ViewBag.Products)
                        {
                            <option value="@p.prod_name_service"
                                    data-price="@p.price"
                                    data-discount="@p.discount"
                                    selected="@(p.prod_name_service == Model.prod_name_service ? "selected" : null)">
                                @p.prod_name_service - $@p.price
                            </option>
                        }
                    </select>
                    <input type="hidden" asp-for="prod_name_service" id="prod_name_service" />
                </div>

                <div>
                    <input asp-for="qty_unit_type" id="quantityInput" class="form-control"
                           style="padding: 0.7rem; border-radius: 12px; border: 1px solid var(--border);" placeholder="Qty / Unit" />
                </div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1rem;">
                <div>
                    <input asp-for="price" id="priceInput" type="number" step="0.01" class="form-control"
                           style="padding: 0.7rem; border-radius: 12px; border: 1px solid var(--border);" placeholder="Unit Price" />
                </div>
                <div>
                    <input asp-for="discount" id="discountInput" type="number" step="0.01" class="form-control"
                           style="padding: 0.7rem; border-radius: 12px; border: 1px solid var(--border);" placeholder="Discount" />
                </div>
                <div>
                    <input asp-for="expiry_date" type="date" class="form-control"
                           style="padding: 0.7rem; border-radius: 12px; border: 1px solid var(--border);" />
                </div>
            </div>
        </div>

        <!-- Total Display -->
        <div style="background: var(--text); color: var(--white); border-radius: 14px; padding: 1.4rem 1.6rem; margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center;">
            <div>
                <div style="font-size: 0.85rem; opacity: 0.75;">Total Sale Amount</div>
                <div style="font-size: 0.7rem; opacity: 0.6;">(Price Ã— Qty) - Discount</div>
            </div>
            <div id="totalDisplay" style="font-size: 1.8rem; font-weight: 800; color: var(--primary-hover);">
                $@Model.total_price.ToString("N2")
            </div>
        </div>

        <!-- Notes Box -->
        <div style="margin-bottom: 1.5rem;">
            <textarea asp-for="description" class="form-control"
                      style="padding: 0.8rem; border-radius: 14px; border: 1px solid var(--border); background: var(--white); width: 100%; min-height: 80px;"
                      placeholder="Note..."></textarea>
        </div>

        <!-- Buttons -->
        <div style="display: flex; gap: 1rem;">
            <button type="submit" class="btn-primary" style="flex: 1; justify-content: center; padding: 0.9rem;">
                <i class="ph-floppy-disk"></i> Update Sale
            </button>
            <a asp-action="Index" class="btn-primary" style="flex: 0.5; justify-content: center; background: var(--white); color: var(--text); border: 1px solid var(--border);">
                Cancel
            </a>
        </div>
    </form>
</div>



<script>
    document.addEventListener('DOMContentLoaded', function() {
        const productSelect = document.getElementById('productSelect');
        const prodNameHidden = document.getElementById('prod_name_service');
        const quantityInput = document.getElementById('quantityInput');
        const priceInput = document.getElementById('priceInput');
        const discountInput = document.getElementById('discountInput');
        const totalDisplay = document.getElementById('totalDisplay');

        function calculateTotal() {
            const qtyNum = parseFloat(quantityInput.value.split(' ')[0]) || 0;
            const price = parseFloat(priceInput.value) || 0;
            const discount = parseFloat(discountInput.value) || 0;
            const total = (price * qtyNum) - discount;
            totalDisplay.textContent = '$' + total.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        productSelect.addEventListener('change', function() {
            const selected = this.options[this.selectedIndex];
            if (selected.value) {
                prodNameHidden.value = selected.value;
                priceInput.value = selected.dataset.price || 0;
                discountInput.value = selected.dataset.discount || 0;
            } else {
                prodNameHidden.value = "";
                priceInput.value = 0;
                discountInput.value = 0;
            }
            calculateTotal();
        });

        [quantityInput, priceInput, discountInput].forEach(el => el.addEventListener('input', calculateTotal));

        calculateTotal();
    });
</script>
