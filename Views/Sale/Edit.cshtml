@model E_Invoice_system.Models.Sale

<div class="dashboard-panel">
    <div class="page-header">
        <h1 class="page-title-large">
            Edit Sale Transaction
        </h1>
        <a asp-action="Index" class="btn-secondary">
            <i class="ph-arrow-left"></i> Back to List
        </a>
    </div>

    <div class="form-wrapper form-layout-complex">
        <form asp-action="Edit" method="post">
            @Html.AntiForgeryToken()
            <input type="hidden" asp-for="id" />
            <input type="hidden" asp-for="date" />

            <!-- Section 1: Sale Info -->
            <div class="form-section">
                <div class="form-section-header">
                    <h3 class="form-section-title">
                        <i class="ph-receipt" style="color: var(--primary);"></i>
                        Sale Details
                    </h3>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label asp-for="customer_name" class="form-label">Customer Name</label>
                        <input asp-for="customer_name" class="form-control" placeholder="Customer Name" />
                        <span asp-validation-for="customer_name" class="text-danger"></span>
                    </div>

                    <div class="form-group">
                        <label asp-for="payment_method" class="form-label">Payment Method</label>
                        <select asp-for="payment_method" class="form-control">
                            <option value="">Payment Method</option>
                            <option value="Cash">Cash</option>
                            <option value="Card">Card</option>
                            <option value="Bank Transfer">Bank Transfer</option>
                            <option value="Mobile Payment">Mobile Payment</option>
                        </select>
                        <span asp-validation-for="payment_method" class="text-danger"></span>
                    </div>

                    <div class="form-group">
                        <label asp-for="status" class="form-label">Status</label>
                        <select asp-for="status" class="form-control">
                            <option value="">Status</option>
                            <option value="Paid">Paid</option>
                            <option value="Pending">Pending</option>
                            <option value="Cancelled">Cancelled</option>
                        </select>
                        <span asp-validation-for="status" class="text-danger"></span>
                    </div>
                </div>
            </div>

            <!-- Section 2: Product Info -->
            <div class="form-section">
                <div class="form-section-header">
                    <h3 class="form-section-title">
                        <i class="ph-package" style="color: var(--primary);"></i>
                        Product Information
                    </h3>
                </div>

                <div style="background: var(--bg-light); border: 1px solid var(--border); border-radius: 8px; padding: 1.5rem; margin-bottom: 2rem;">
                    <div class="form-grid" style="grid-template-columns: 2fr 1fr; margin-bottom: 1rem;">
                        <div class="form-group">
                            <label class="form-label">Product</label>
                            <select id="productSelect" class="form-control">
                                <option value="">Select a product...</option>
                                @foreach (var p in ViewBag.Products)
                                {
                                    <option value="@p.prod_name_service"
                                            data-price="@p.price"
                                            data-discount="@p.discount"
                                            selected="@(p.prod_name_service == Model.prod_name_service ? "selected" : null)">
                                        @p.prod_name_service - $@p.price
                                    </option>
                                }
                            </select>
                            <input type="hidden" asp-for="prod_name_service" id="prod_name_service" />
                        </div>
                        <div class="form-group">
                            <label asp-for="qty_unit_type" class="form-label">QTY / UNIT</label>
                            <input asp-for="qty_unit_type" id="quantityInput" class="form-control" placeholder="QTY / UNIT" />
                        </div>
                    </div>

                    <div class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));">
                        <div class="form-group">
                            <label asp-for="price" class="form-label">Unit Price ($)</label>
                            <input asp-for="price" id="priceInput" type="number" step="0.01" class="form-control" placeholder="Unit Price" />
                        </div>
                        <div class="form-group">
                            <label asp-for="discount" class="form-label">Discount ($)</label>
                            <input asp-for="discount" id="discountInput" type="number" step="0.01" class="form-control" placeholder="Discount" />
                        </div>
                        <div class="form-group">
                            <label asp-for="expiry_date" class="form-label">Expiry Date</label>
                            <input asp-for="expiry_date" type="date" class="form-control" />
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 3: Summary -->
            <div class="form-section">
                <div class="form-section-header">
                    <h3 class="form-section-title">
                        <i class="ph-calculator" style="color: var(--primary);"></i>
                        Summary
                    </h3>
                </div>
                
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <div style="display: flex; justify-content: flex-end; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                        <span style="font-size: 1.1rem; font-weight: 600; color: var(--text);">Total Amount:</span>
                        <div id="totalDisplay" style="font-size: 2rem; font-weight: 800; color: var(--primary);">
                            $@Model.total_price.ToString("N2")
                        </div>
                    </div>

                    <div class="form-group">
                        <label asp-for="description" class="form-label">Internal Notes (Optional)</label>
                        <textarea asp-for="description" class="form-control" rows="3" placeholder="Note..." data-val="false"></textarea>
                    </div>
                </div>
            </div>

            <div class="form-actions-sticky">
                <a asp-action="Index" class="btn-secondary">
                    Cancel
                </a>
                <button type="submit" class="btn-primary">
                    <i class="ph-floppy-disk"></i>
                    Update Sale
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const productSelect = document.getElementById('productSelect');
        const prodNameHidden = document.getElementById('prod_name_service');
        const quantityInput = document.getElementById('quantityInput');
        const priceInput = document.getElementById('priceInput');
        const discountInput = document.getElementById('discountInput');
        const totalDisplay = document.getElementById('totalDisplay');

        function calculateTotal() {
            const qtyNum = parseFloat(quantityInput.value.split(' ')[0]) || 0;
            const price = parseFloat(priceInput.value) || 0;
            const discount = parseFloat(discountInput.value) || 0;
            const total = (price * qtyNum) - discount;
            totalDisplay.textContent = '$' + total.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        productSelect.addEventListener('change', function() {
            const selected = this.options[this.selectedIndex];
            // ID for expiry assumed to be default asp-for generated ID 'expiry_date'
            const expiryInput = document.getElementById('expiry_date'); 
            
            if (selected.value) {
                prodNameHidden.value = selected.value;
                priceInput.value = selected.dataset.price || 0;
                discountInput.value = selected.dataset.discount || 0;
                
                // Set fields to read-only
                priceInput.readOnly = true;
                discountInput.readOnly = true;
                if(expiryInput) expiryInput.readOnly = true;
                
            } else {
                prodNameHidden.value = "";
                priceInput.value = 0;
                discountInput.value = 0;
                
                // Allow editing if cleared (optional behavior)
                priceInput.readOnly = false;
                discountInput.readOnly = false;
                if(expiryInput) expiryInput.readOnly = false;
            }
            calculateTotal();
        });

        [quantityInput, priceInput, discountInput].forEach(el => el.addEventListener('input', calculateTotal));

        calculateTotal();
    });
</script>
