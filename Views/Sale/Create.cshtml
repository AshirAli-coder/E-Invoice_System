@model E_Invoice_system.Models.Sale
@{
    var customers = ViewBag.Customers as List<E_Invoice_system.Models.customers>;
    var products = ViewBag.Products as List<E_Invoice_system.Models.ProductService>;
}

<div class="pos-container">
    <!-- Left: Product Catalog -->
    <div class="catalog-section">
            <div class="catalog-header">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2 class="catalog-title" style="margin-bottom: 0;">
                        <i class="ph-package"></i> Product Catalog
                    </h2>
                    
                    <!-- Search Mode Toggle (Moved Here) -->
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <span style="font-size: 0.75rem; font-weight: 700; color: #64748b; letter-spacing: 0.05em; text-transform: uppercase;">Search By</span>
                        <div class="toggle-group">
                            <div class="toggle-option">
                                <input type="radio" id="searchName" name="searchMode" value="name" checked onchange="updateSearchPlaceholder(); filterProducts();">
                                <label for="searchName">Name</label>
                            </div>
                            <div class="toggle-option">
                                <input type="radio" id="searchBarcode" name="searchMode" value="barcode" onchange="updateSearchPlaceholder(); filterProducts();">
                                <label for="searchBarcode">Barcode</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="search-wrapper">
                    <i class="ph-magnifying-glass"></i>
                    <input type="text" id="prodSearch" placeholder="Search by name..." oninput="filterProducts()" />
               </div>
            </div>

        <div class="product-grid" id="productGrid">
            @if (products != null)
            {
                foreach (var p in products)
                {
                    <div class="product-card" data-name="@p.prod_name_service.ToLower()" data-barcode="@(p.barcode?.ToLower() ?? "")" onclick="addToSaleFromCard(@p.id, '@p.prod_name_service', @p.price, @p.discount, '@(p.expiry_date?.ToString("yyyy-MM-dd"))', '@(p.barcode ?? "")')">
                        <div class="product-icon-box">
                            <i class="ph-cube"></i>
                        </div>
                        <div class="product-info">
                            <h4 class="prod-card-name">@p.prod_name_service</h4>
                            <p class="prod-card-price">$@p.price.ToString("N2")</p>
                            @if (p.discount > 0)
                            {
                                <span class="prod-card-discount">Save $@p.discount.ToString("N2")</span>
                            }
                            @if (!string.IsNullOrEmpty(p.qty_unit_type))
                            {
                                <div style="font-size: 0.75rem; color: #64748b; margin-top: 4px; font-weight: 600;">
                                    <i class="ph-package" style="font-size: 0.7rem;"></i> Stock: @p.qty_unit_type
                                </div>
                            }
                        </div>
                    </div>
                }
            }
        </div>
    </div>

    <!-- Right: Sale Form & Cart -->
    <div class="cart-section">
        <form asp-action="Create" method="post" id="saleForm" style="display: flex; flex-direction: column; height: 100%; overflow: hidden;">
            @Html.AntiForgeryToken()
            <input type="hidden" name="payment_method" id="hiddenPaymentMethod" value="Cash" />
            <input type="hidden" name="status" id="hiddenStatus" value="Paid" />
            
            <div class="cart-header-pos">
                <h3 class="catalog-title"><i class="ph-shopping-cart-simple"></i> Current Sale</h3>
                <button type="button" class="btn-clear-pos" onclick="clearSaleItems()">
                    <i class="ph-trash"></i>
                </button>
            </div>
            
            <!-- Transaction Mode -->
            <!-- Transaction Mode Toggle -->
            <div style="padding: 0 1rem; margin-bottom: 1rem; display: flex; gap: 1rem; align-items: center;">
                <span style="font-size: 0.85rem; font-weight: 700; color: #475569; letter-spacing: 0.02em;">MODE</span>
                <div class="toggle-group">
                    <div class="toggle-option toggle-mode-sale">
                        <input type="radio" id="modeSale" name="transMode" value="sale" checked>
                        <label for="modeSale">Sale</label>
                    </div>
                    <div class="toggle-option toggle-mode-return">
                        <input type="radio" id="modeReturn" name="transMode" value="return">
                        <label for="modeReturn">Return</label>
                    </div>
                </div>
            </div>

            <div class="cart-meta-pos">


                <div class="form-group">
                    <label class="form-label">Customer</label>
                    <select name="customer_name" class="form-control" required>
                        <option value="">-- Select Customer --</option>
                        @if (customers != null)
                        {
                            foreach (var c in customers)
                            {
                                <option value="@c.name">@c.name</option>
                            }
                        }
                    </select>
                </div>
            </div>

            <div class="cart-items-wrapper">
                <table class="pos-table">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th style="width: 80px;">QTY/Unit type</th>
                            <th style="width: 80px;">Total</th>
                            <th style="width: 40px;"></th>
                        </tr>
                    </thead>
                    <tbody id="saleItemsBody">
                        <!-- Items populated by JS -->
                    </tbody>
                </table>
                <div id="emptyCartState" class="empty-cart-state">
                    <i class="ph-shopping-bag-open"></i>
                    <p>No items added yet</p>
                </div>
            </div>

            <div class="cart-footer-pos">
                <div class="summary-line-pos">
                    <span>Subtotal</span>
                    <span id="subtotalDisplay">$0.00</span>
                </div>
                <div class="summary-line-pos">
                    <span>Total Discount</span>
                    <span id="discountDisplay" style="color: #ef4444;">-$0.00</span>
                </div>
                <div class="total-box-pos">
                    <span class="total-label">GRAND TOTAL</span>
                    <span class="total-value" id="grandTotal">$0.00</span>
                </div>


                <div id="hiddenInputsContainer"></div>

                <button type="button" class="btn-checkout-pos" onclick="openPaymentModal()">
                    <i class="ph-credit-card"></i> PROCEED TO PAYMENT
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Payment Modal -->
<div class="modal-overlay" id="paymentModal">
    <div class="payment-modal">
        <header class="modal-header">
            <div class="header-title-modal">
                <i class="ph-cash-register"></i>
                <h3>Payment</h3>
            </div>
            <div class="header-total-modal">
                <span>Total Amount:</span>
                <span class="total-amount-large" id="modalTotalAmount">$0.00</span>
            </div>
            <button class="btn-close-modal" onclick="closePaymentModal()"><i class="ph-x"></i></button>
        </header>

        <div class="payment-body">
            <!-- LEFT: Methods & Quick Cash -->
            <div class="payment-left">
                <div class="methods-grid">
                    <button type="button" class="pay-method-btn card-blue" onclick="selectPaymentMethod('Card', this)">
                        <i class="ph-credit-card"></i> CREDIT CARD
                    </button>
                    <button type="button" class="pay-method-btn cash-green active" onclick="selectPaymentMethod('Cash', this)">
                        <i class="ph-money"></i> CASH
                    </button>
                    <button type="button" class="pay-method-btn online-orange" onclick="selectPaymentMethod('Online', this)">
                        <i class="ph-globe"></i> ONLINE
                    </button>
                    <button type="button" class="pay-method-btn credit-purple" onclick="selectPaymentMethod('Credit', this)">
                        <i class="ph-receipt"></i> CREDIT / LATER
                    </button>
                </div>

                <div class="quick-cash-grid">
                    <button type="button" class="quick-btn" onclick="addQuickCash(1)">$1</button>
                    <button type="button" class="quick-btn" onclick="addQuickCash(5)">$5</button>
                    <button type="button" class="quick-btn" onclick="addQuickCash(10)">$10</button>
                    <button type="button" class="quick-btn" onclick="addQuickCash(20)">$20</button>
                    <button type="button" class="quick-btn" onclick="addQuickCash(50)">$50</button>
                    <button type="button" class="quick-btn" onclick="addQuickCash(100)">$100</button>
                </div>
            </div>

            <!-- RIGHT: Numpad & Summary -->
            <div class="payment-right">
                <div class="premium-summary-box">
                    <div class="summary-item-modal">
                        <span class="label">Amount Due</span>
                        <span class="value dark" id="modalAmountDue">$0.00</span>
                    </div>
                    <div class="summary-item-modal">
                        <span class="label">Tendered</span>
                        <span class="value blue" id="modalTendered">$0.00</span>
                    </div>
                    <div class="summary-item-modal highlight">
                        <span class="label">Change Due</span>
                        <span class="value red" id="modalChange">$0.00</span>
                    </div>
                </div>

                <div class="tender-input-wrapper">
                    <input type="text" placeholder="CASH TEND" class="tender-input" id="cashTendered" oninput="handleKeyboardInput(this.value)" />
                </div>

                <div class="numpad-grid">
                    <button type="button" class="num-btn" onclick="appendToTender('7')">7</button>
                    <button type="button" class="num-btn" onclick="appendToTender('8')">8</button>
                    <button type="button" class="num-btn" onclick="appendToTender('9')">9</button>
                    <button type="button" class="num-btn" onclick="appendToTender('4')">4</button>
                    <button type="button" class="num-btn" onclick="appendToTender('5')">5</button>
                    <button type="button" class="num-btn" onclick="appendToTender('6')">6</button>
                    <button type="button" class="num-btn" onclick="appendToTender('1')">1</button>
                    <button type="button" class="num-btn" onclick="appendToTender('2')">2</button>
                    <button type="button" class="num-btn" onclick="appendToTender('3')">3</button>
                    <button type="button" class="num-btn" onclick="appendToTender('0')">0</button>
                    <button type="button" class="num-btn" onclick="appendToTender('00')">00</button>
                    <button type="button" class="num-btn" onclick="appendToTender('.')">.</button>
                    <button type="button" class="num-btn" onclick="clearTender()" style="color: #e11d48;"><i class="ph-backspace"></i></button>
                </div>

                <div class="payment-actions-modal">
                    <button type="button" class="btn-submit-pay" onclick="submitSale()">
                        <i class="ph-check-circle"></i> CONFIRM PAYMENT
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let saleItems = [];
    let currentTotal = 0;
    let tenderedAmount = "";

    function updateSearchPlaceholder() {
        const mode = document.querySelector('input[name="searchMode"]:checked').value;
        const input = document.getElementById('prodSearch');
        if (mode === 'name') {
            input.placeholder = "Search by name...";
        } else {
            input.placeholder = "Search by barcode...";
        }
    }

    function filterProducts() {
        const term = document.getElementById('prodSearch').value.toLowerCase();
        const mode = document.querySelector('input[name="searchMode"]:checked').value;
        const cards = document.querySelectorAll('.product-card');
        
        cards.forEach(card => {
            let match = false;
            if (mode === 'name') {
                const name = card.dataset.name; // Use data attribute
                match = name.includes(term);
            } else {
                const barcode = card.dataset.barcode; // Use data attribute
                match = barcode.includes(term);
                
                // If exact match on barcode, maybe auto-add? (Optional enhancement)
            }
            card.style.display = match ? '' : 'none';
        });
    }

    function addToSaleFromCard(id, name, price, discount, expiry, barcode) {
        // Check transaction mode
        const mode = document.querySelector('input[name="transMode"]:checked').value;
        const isReturn = mode === 'return';
        const qtyToAdd = isReturn ? -1 : 1;

        // Check if item already in sale
        const existing = saleItems.find(i => i.prod_name_service === name);
        if (existing) {
            // Logic: if return mode, adding means decreasing existing quantity (more negative)
            // But we simplify: just add qtyToAdd. 
            // If existing is 1 and we add -1, it becomes 0 (remove?). 
            // Or if existing is -1 and we add -1, it becomes -2.
            
            existing.qty += qtyToAdd;
            
            // If qty becomes 0, remove item?
            if (existing.qty === 0) {
                const idx = saleItems.indexOf(existing);
                if (idx > -1) removeItem(idx);
                return;
            }
            
            existing.total_price = (existing.price * existing.qty) - (existing.discount * existing.qty);
        } else {
            saleItems.push({
                prod_name_service: name,
                barcode: barcode || null,
                qty: qtyToAdd,
                price: price,
                discount: discount,
                expiry_date: expiry || null,
                total_price: (price * qtyToAdd) - (discount * qtyToAdd)
            });
        }
        renderSaleItems();
    }

    function decreaseQty(index) {
        const item = saleItems[index];
        // If qty positive, decrease towards 0. If negative (return), decrease means more negative? No, usually "decrease quantity" button means "less items".
        // But here visuals are tricky. 
        // Let's assume buttons mean: (+) adds 1 (or -1 if return mode?? No, buttons are per item row).
        // Let's make buttons always +/- 1 magnitude?
        // Simpler: (-) subtracts 1 from qty. (+) adds 1 to qty.
        // If qty is -1 (Return), (-) makes it -2 (More items returned). (+) makes it 0 (Less items returned).
        
        item.qty--;
        if (item.qty === 0) {
            removeItem(index);
        } else {
            item.total_price = (item.price * item.qty) - (item.discount * item.qty);
            renderSaleItems();
        }
    }

    function increaseQty(index) {
        const item = saleItems[index];
        item.qty++;
        if (item.qty === 0) {
            removeItem(index);
        } else {
            item.total_price = (item.price * item.qty) - (item.discount * item.qty);
            renderSaleItems();
        }
    }

    function removeItem(index) {
        saleItems.splice(index, 1);
        renderSaleItems();
    }

    function clearSaleItems() {
        if (confirm("Are you sure you want to clear this sale?")) {
            saleItems = [];
            renderSaleItems();
        }
    }

    function renderSaleItems() {
        const body = document.getElementById('saleItemsBody');
        const empty = document.getElementById('emptyCartState');
        const hiddenContainer = document.getElementById('hiddenInputsContainer');
        const grandTotalSpan = document.getElementById('grandTotal');
        const subtotalSpan = document.getElementById('subtotalDisplay');
        const discountSpan = document.getElementById('discountDisplay');

        body.innerHTML = "";
        hiddenContainer.innerHTML = "";

        if (saleItems.length === 0) {
            empty.style.display = "block";
            grandTotalSpan.innerText = "$0.00";
            subtotalSpan.innerText = "$0.00";
            discountSpan.innerText = "-$0.00";
            currentTotal = 0;
            return;
        }
        empty.style.display = "none";

        let totalSub = 0;
        let totalDisc = 0;
        let grandTotal = 0;

        saleItems.forEach((item, index) => {
            const lineSub = item.price * item.qty;
            const lineDisc = item.discount * item.qty;
            const lineTotal = lineSub - lineDisc;

            totalSub += lineSub;
            totalDisc += lineDisc;
            grandTotal += lineTotal;

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>
                    <div class="item-row-name">${item.prod_name_service}</div>
                    <div style="font-size: 0.7rem; color: #94a3b8;">$${item.price.toFixed(2)}</div>
                </td>
                <td class="item-row-qty">
                    <div style="display:flex; align-items:center; gap:5px;">
                        <button type="button" onclick="decreaseQty(${index})" style="background: #f1f5f9; border: none; border-radius: 4px; padding: 2px 6px; cursor: pointer; color: #DC2626;"><i class="ph-minus"></i></button>
                        <span>${item.qty}</span>
                        <button type="button" onclick="increaseQty(${index})" style="background: #f1f5f9; border: none; border-radius: 4px; padding: 2px 6px; cursor: pointer; color: #0F172A;"><i class="ph-plus"></i></button>
                    </div>
                </td>
                <td class="item-row-total">$${lineTotal.toFixed(2)}</td>
                <td style="text-align: right;">
                    <button type="button" onclick="removeItem(${index})" style="background:none; border:none; color:#cbd5e1; cursor:pointer;"><i class="ph-x-bold"></i></button>
                </td>
            `;
            body.appendChild(tr);

            const prefix = `items[${index}]`;
            hiddenContainer.innerHTML += `
                <input type="hidden" name="${prefix}.prod_name_service" value="${item.prod_name_service}" />
                <input type="hidden" name="${prefix}.barcode" value="${item.barcode || ''}" />
                <input type="hidden" name="${prefix}.qty_unit_type" value="${item.qty}" />
                <input type="hidden" name="${prefix}.price" value="${item.price}" />
                <input type="hidden" name="${prefix}.discount" value="${item.discount}" />
                <input type="hidden" name="${prefix}.expiry_date" value="${item.expiry_date || ''}" />
                <input type="hidden" name="${prefix}.total_price" value="${lineTotal}" />
            `;
        });

        currentTotal = grandTotal;
        
        // Format with proper sign for negative values
        const formatCurrency = (value) => {
            const absValue = Math.abs(value);
            const formatted = absValue.toLocaleString(undefined, { minimumFractionDigits: 2 });
            return value < 0 ? `-$${formatted}` : `$${formatted}`;
        };
        
        subtotalSpan.innerText = formatCurrency(totalSub);
        discountSpan.innerText = totalDisc >= 0 ? `-$${totalDisc.toLocaleString(undefined, { minimumFractionDigits: 2 })}` : `$${Math.abs(totalDisc).toLocaleString(undefined, { minimumFractionDigits: 2 })}`;
        grandTotalSpan.innerText = formatCurrency(grandTotal);
    }

    // Modal & Payment Logic
    function openPaymentModal() {
        if (saleItems.length === 0) {
            alert("Please add items to the cart first.");
            return;
        }
        
        
        // Update modal totals
        const formatCurrency = (value) => {
            const absValue = Math.abs(value);
            const formatted = absValue.toLocaleString(undefined, { minimumFractionDigits: 2 });
            return value < 0 ? `-$${formatted}` : `$${formatted}`;
        };
        
        const formattedTotal = formatCurrency(currentTotal);
        document.getElementById('modalTotalAmount').innerText = formattedTotal;
        document.getElementById('modalAmountDue').innerText = formattedTotal;
        
        // Reset tender
        clearTender();
        
        document.getElementById('paymentModal').classList.add('show');
    }

    function closePaymentModal() {
        document.getElementById('paymentModal').classList.remove('show');
    }

    function selectPaymentMethod(method, btn) {
        // Update hidden input
        document.getElementById('hiddenPaymentMethod').value = method;
        
        // Update status based on method (simple logic)
        document.getElementById('hiddenStatus').value = (method === 'Credit') ? 'Pending' : 'Paid';

        // UI Update
        document.querySelectorAll('.pay-method-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    function appendToTender(val) {
        if (val === '.' && tenderedAmount.includes('.')) return;
        tenderedAmount += val;
        updateTenderDisplay();
    }

    function addQuickCash(amount) {
        let current = parseFloat(tenderedAmount) || 0;
        tenderedAmount = (current + amount).toFixed(2);
        updateTenderDisplay();
    }

    function clearTender() {
        tenderedAmount = "";
        updateTenderDisplay();
    }

    function handleKeyboardInput(value) {
        // Remove $ and commas, keep only numbers and decimal point
        const cleaned = value.replace(/[$,]/g, '');
        
        // Validate it's a valid number format
        if (cleaned === '' || /^\d*\.?\d*$/.test(cleaned)) {
            tenderedAmount = cleaned;
            updateTenderDisplay();
        }
    }

    function updateTenderDisplay() {
        const displayVal = tenderedAmount === "" ? "" : "$" + parseFloat(tenderedAmount).toLocaleString(undefined, { minimumFractionDigits: 2 });
        document.getElementById('cashTendered').value = displayVal;
        
        const tenderVal = parseFloat(tenderedAmount) || 0;
        document.getElementById('modalTendered').innerText = "$" + tenderVal.toLocaleString(undefined, { minimumFractionDigits: 2 });
        
        const change = tenderVal - currentTotal;
        
        // For returns (negative total), change calculation is different
        // If total is -500 and tender is 0, change should be 500 (money back to customer)
        const formatCurrency = (value) => {
            const absValue = Math.abs(value);
            const formatted = absValue.toLocaleString(undefined, { minimumFractionDigits: 2 });
            return value < 0 ? `-$${formatted}` : `$${formatted}`;
        };
        
        document.getElementById('modalChange').innerText = formatCurrency(change);
    }

    function submitSale() {
        // Validate customer
        const customerSelect = document.querySelector('select[name="customer_name"]');
        if (!customerSelect.value) {
            alert("Please select a customer from the main screen.");
            closePaymentModal();
            customerSelect.focus();
            return;
        }

        // Validate tender for cash
        const method = document.getElementById('hiddenPaymentMethod').value;
        const tenderVal = parseFloat(tenderedAmount) || 0;
        
        // For returns (negative total), we don't need tender validation
        // For sales, validate tender is sufficient
        if (method === 'Cash' && currentTotal > 0 && tenderVal < currentTotal) {
            if(!confirm("Tendered amount is less than total. Record as partial payment/credit?")) {
                return;
            }
        }

        document.getElementById('saleForm').submit();
    }
</script>
