@model E_Invoice_system.Models.Sale
@{
    var customers = ViewBag.Customers as List<E_Invoice_system.Models.customers>;
    var products = ViewBag.Products as List<E_Invoice_system.Models.ProductService>;
}

<div class="pos-container">
    <!-- Left: Product Catalog -->
    <div class="catalog-section">
        <div class="catalog-header">
            <div class="catalog-title">
                <i><i class="ph-shopping-bag"></i></i>
                Product Catalog
            </div>

            <div class="search-container">
                <div class="search-wrapper">
                    <i class="ph-magnifying-glass"></i>
                    <input type="text" id="prodSearch" placeholder="Search products..." oninput="filterProducts()" />
                </div>
                
                <div class="modern-toggle">
                    <input type="radio" id="searchName" name="searchMode" value="name" checked onchange="updateSearchPlaceholder(); filterProducts();">
                    <label for="searchName">By Name</label>
                    <input type="radio" id="searchBarcode" name="searchMode" value="barcode" onchange="updateSearchPlaceholder(); filterProducts();">
                    <label for="searchBarcode">Barcode</label>
                </div>
            </div>

            @if (!ViewData.ModelState.IsValid)
            {
                <div class="alert alert-danger" style="margin-top: 16px; padding: 12px 20px; border-radius: 12px; background: #fee2e2; border: 1px solid #fecaca; color: #dc2626; font-size: 0.85rem; font-weight: 600;">
                    @Html.ValidationSummary(false, "")
                </div>
            }
        </div>

        <div class="product-grid" id="productGrid">
            @if (products != null)
            {
                foreach (var p in products)
                {
                    decimal stockValue = 0;
                    if (!string.IsNullOrEmpty(p.qty_unit_type))
                    {
                        var parts = p.qty_unit_type.Trim().Split(' ');
                        decimal.TryParse(parts[0], out stockValue);
                    }
                    <div class="product-card" data-name="@p.prod_name_service.ToLower()" data-barcode="@(p.barcode?.ToLower() ?? "")" data-stock="@stockValue" onclick="addToSaleFromCard(@p.id, '@p.prod_name_service', @p.price, @p.discount, '@(p.expiry_date?.ToString("yyyy-MM-dd"))', '@(p.barcode ?? "")', @stockValue)">
                        <div class="product-icon-box">
                            <i class="ph-cube"></i>
                        </div>
                        <h4 class="prod-card-name">@p.prod_name_service</h4>
                        <p class="prod-card-price">$@p.price.ToString("N2")</p>
                        @if (p.discount > 0)
                        {
                            <span style="font-size: 0.7rem; color: var(--success); font-weight: 700; background: var(--success-bg); padding: 4px 8px; border-radius: 8px; margin-top: 8px;">-$@p.discount.ToString("N2")</span>
                        }
                    </div>
                }
            }
        </div>
    </div>

    <!-- Right: Order Summary -->
    <div class="cart-section">
        <form asp-action="Create" method="post" id="saleForm" style="display: flex; flex-direction: column; height: 100%; overflow: hidden;">
            @Html.AntiForgeryToken()
            <input type="hidden" name="payment_method" id="hiddenPaymentMethod" value="Cash" />
            <input type="hidden" name="status" id="hiddenStatus" value="Paid" />
            
            <div class="cart-header">
                <h3>Order Summary</h3>
                <button type="button" class="btn-clear" onclick="clearSaleItems()">Clear All</button>
            </div>
            
            <div class="cart-meta">
                <div class="form-label-mini">Transaction Mode</div>
                <div class="modern-toggle" style="margin-bottom: 24px;">
                    <input type="radio" id="modeSale" name="transMode" value="sale" checked onchange="handleModeChange()">
                    <label for="modeSale" style="flex: 1; text-align: center;">Standard Sale</label>
                    <input type="radio" id="modeReturn" name="transMode" value="return" onchange="handleModeChange()">
                    <label for="modeReturn" style="flex: 1; text-align: center;">Return Item</label>
                </div>

                <div class="form-label-mini">Customer</div>
                <select name="customer_name" class="modern-select" required>
                    <option value="">-- Select Customer --</option>
                    @if (customers != null)
                    {
                        foreach (var c in customers)
                        {
                            <option value="@c.name">@c.name</option>
                        }
                    }
                </select>
            </div>

            <div class="cart-items" id="saleItemsBody">
                <!-- Items populated by JS as checkout-item divs -->
            </div>

            <div id="emptyCartState" style="padding: 40px; text-align: center; color: var(--text-muted);">
                <i class="ph-shopping-cart" style="font-size: 3rem; opacity: 0.2; display: block; margin-bottom: 16px;"></i>
                <p style="font-weight: 500;">No items in your order.</p>
            </div>

            <div class="cart-footer">
                <div class="summary-line-pos">
                    <span>Subtotal</span>
                    <span id="subtotalDisplay">$0.00</span>
                </div>
                <div class="summary-line-pos">
                    <span>Discount</span>
                    <span id="discountDisplay" style="color: var(--primary);">-$0.00</span>
                </div>

                <div id="stockAlert" style="display: none; margin: 16px 0; padding: 12px; border-radius: 12px; background: #fff1f2; border: 1px solid #fda4af; color: #be123c; font-size: 0.85rem; font-weight: 700; text-align: center;">
                    <i class="ph-warning-circle"></i> <span id="stockAlertMsg"></span>
                </div>

                <div class="summary-row total">
                    <span>Grand Total</span>
                    <span id="grandTotal">$0.00</span>
                </div>

                <div id="hiddenInputsContainer"></div>

                <button type="button" class="btn-payment" onclick="openPaymentModal()">
                    Proceed to Payment <i class="ph-arrow-right"></i>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modern Web Payment Modal -->
<div class="modal-overlay" id="paymentModal">
    <div class="payment-card">
        <!-- Left Side: Payment Input -->
        <div class="payment-left">
            <h2 style="font-size: 1.5rem; font-weight: 800; margin-bottom: 32px; color: var(--text-header);">Select Payment Method</h2>
            
            <div class="method-tabs">
                <button type="button" class="method-tab active" id="btnCash" onclick="setWebPaymentMethod('Cash')">
                    <i class="ph-money"></i> Cash
                </button>
                <button type="button" class="method-tab" id="btnCard" onclick="setWebPaymentMethod('Card')">
                    <i class="ph-credit-card"></i> Card
                </button>
                <button type="button" class="method-tab" id="btnTransfer" onclick="setWebPaymentMethod('Transfer')">
                    <i class="ph-bank"></i> Transfer
                </button>
                <button type="button" class="method-tab" id="btnCredit" onclick="setWebPaymentMethod('Credit')">
                    <i class="ph-user-circle-plus"></i> Store Credit
                </button>
            </div>

            <div class="web-input-group">
                <label>Amount Tendered</label>
                <input type="number" id="webTendered" class="web-input" placeholder="0.00" oninput="calculateWebChange()" step="0.01">
                
                <div class="quick-pills">
                    <div class="quick-pill" onclick="addWebAmount(10)">+ $10</div>
                    <div class="quick-pill" onclick="addWebAmount(20)">+ $20</div>
                    <div class="quick-pill" onclick="addWebAmount(50)">+ $50</div>
                    <div class="quick-pill" onclick="addWebAmount(100)">+ $100</div>
                    <div class="quick-pill" onclick="matchWebAmount()">Match Total</div>
                </div>
            </div>

            <div class="web-input-group">
                <label>Reference / Note</label>
                <input type="text" name="notes" class="web-input" placeholder="Transaction notes (optional)">
            </div>
        </div>

        <!-- Right Side: Summary & Confirm -->
        <div class="payment-right">
            <div class="summary-box-web">
                <div class="summary-web-line">
                    <span style="color: var(--text-muted); font-weight: 600;">Total Amount Due</span>
                    <span id="webModalTotal" style="font-weight: 700;">$0.00</span>
                </div>
                <div class="summary-web-line" style="margin-top: 8px;">
                    <span style="color: var(--text-muted); font-weight: 600;">Total Tendered</span>
                    <span id="webModalTendered" style="font-weight: 700;">$0.00</span>
                </div>
                
                <div class="summary-web-line grand">
                    <span>Change Due</span>
                    <span id="webModalChange">$0.00</span>
                </div>
            </div>

            <div style="margin-top: auto;">
                <p style="font-size: 0.75rem; color: var(--text-muted); text-align: center; margin-bottom: 24px; line-height: 1.5;">
                    By completing this order, you agree to generate an official invoice and update stock levels.
                </p>
                
                <div style="display: flex; gap: 16px;">
                    <button type="button" class="btn-confirm-web" style="background: #f1f5f9; color: var(--text-main); flex: 1;" onclick="closePaymentModal()">Cancel</button>
                    <button type="button" class="btn-confirm-web" style="flex: 2; background: var(--primary);" onclick="submitSaleForm()">
                        Complete Order <i class="ph-check-circle"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let saleItems = [];
    let currentTotal = 0;

    function updateSearchPlaceholder() {
        const mode = document.querySelector('input[name="searchMode"]:checked').value;
        const input = document.getElementById('prodSearch');
        input.placeholder = mode === 'name' ? "Search by name..." : "Search by barcode...";
    }

    function handleModeChange() {
        const mode = document.querySelector('input[name="transMode"]:checked').value;
        const isReturn = mode === 'return';
        
        saleItems.forEach(item => {
            const absQty = Math.abs(item.qty);
            item.qty = isReturn ? -absQty : absQty;
            item.total_price = (item.price * item.qty) - (item.discount * item.qty);
        });
        
        renderSaleItems();
    }

    function filterProducts() {
        const term = document.getElementById('prodSearch').value.toLowerCase();
        const mode = document.querySelector('input[name="searchMode"]:checked').value;
        const cards = document.querySelectorAll('.product-card');
        
        cards.forEach(card => {
            const val = mode === 'name' ? card.dataset.name : card.dataset.barcode;
            card.style.display = val.includes(term) ? '' : 'none';
        });
    }

    function addToSaleFromCard(id, name, price, discount, expiry, barcode, maxStock) {
        const mode = document.querySelector('input[name="transMode"]:checked').value;
        const isReturn = mode === 'return';
        const qtyToAdd = isReturn ? -1 : 1;

        const existing = saleItems.find(i => i.prod_name_service === name);
        if (existing) {
            if (!isReturn && (existing.qty + qtyToAdd) > maxStock) {
                showStockAlert(`Only ${maxStock} items available.`);
                return;
            }
            existing.qty += qtyToAdd;
            if (existing.qty === 0) {
                removeItem(saleItems.indexOf(existing));
                return;
            }
            existing.total_price = (existing.price * existing.qty) - (existing.discount * existing.qty);
        } else {
            if (!isReturn && qtyToAdd > maxStock) {
                showStockAlert(`Insufficient stock (${maxStock}).`);
                return;
            }
            saleItems.push({
                prod_name_service: name,
                barcode: barcode || null,
                qty: qtyToAdd,
                price: price,
                discount: discount,
                expiry_date: expiry || null,
                maxStock: maxStock,
                total_price: (price * qtyToAdd) - (discount * qtyToAdd)
            });
        }
        renderSaleItems();
    }

    function decreaseQty(index) {
        saleItems[index].qty--;
        if (saleItems[index].qty === 0) {
            removeItem(index);
        } else {
            const item = saleItems[index];
            item.total_price = (item.price * item.qty) - (item.discount * item.qty);
            renderSaleItems();
        }
    }

    function increaseQty(index) {
        const item = saleItems[index];
        const mode = document.querySelector('input[name="transMode"]:checked').value;
        if (mode !== 'return' && item.qty >= item.maxStock) {
            showStockAlert(`Max stock reached (${item.maxStock}).`);
            return;
        }
        item.qty++;
        item.total_price = (item.price * item.qty) - (item.discount * item.qty);
        renderSaleItems();
    }

    function removeItem(index) {
        saleItems.splice(index, 1);
        renderSaleItems();
    }

    function clearSaleItems() {
        if (saleItems.length > 0 && confirm("Clear current order summary?")) {
            saleItems = [];
            renderSaleItems();
        }
    }

    function renderSaleItems() {
        const body = document.getElementById('saleItemsBody');
        const empty = document.getElementById('emptyCartState');
        const hiddenContainer = document.getElementById('hiddenInputsContainer');
        const subtotalSpan = document.getElementById('subtotalDisplay');
        const discountSpan = document.getElementById('discountDisplay');
        const grandTotalSpan = document.getElementById('grandTotal');

        body.innerHTML = "";
        hiddenContainer.innerHTML = "";

        if (saleItems.length === 0) {
            empty.style.display = "block";
            subtotalSpan.innerText = "$0.00";
            discountSpan.innerText = "-$0.00";
            grandTotalSpan.innerText = "$0.00";
            currentTotal = 0;
            return;
        }
        empty.style.display = "none";

        let totalSub = 0;
        let totalDisc = 0;
        let grandTotal = 0;

        saleItems.forEach((item, index) => {
            const lineSub = item.price * item.qty;
            const lineDisc = item.discount * item.qty;
            const lineTotal = lineSub - lineDisc;

            totalSub += lineSub;
            totalDisc += lineDisc;
            grandTotal += lineTotal;

            const div = document.createElement('div');
            div.className = "checkout-item";
            div.innerHTML = `
                <div class="item-main">
                    <div class="item-title">${item.prod_name_service}</div>
                    <div class="item-sub">$${item.price.toFixed(2)} / unit</div>
                </div>
                <div style="display: flex; align-items: center;">
                    <div class="item-qty-wrap">
                        <button type="button" class="qty-btn-mini" onclick="decreaseQty(${index})">-</button>
                        <span style="font-weight: 700; min-width: 24px; text-align: center; font-size: 0.85rem;">${item.qty}</span>
                        <button type="button" class="qty-btn-mini" onclick="increaseQty(${index})">+</button>
                    </div>
                    <div class="item-price">$${lineTotal.toFixed(2)}</div>
                </div>
            `;
            body.appendChild(div);

            const prefix = `items[${index}]`;
            hiddenContainer.innerHTML += `
                <input type="hidden" name="${prefix}.prod_name_service" value="${item.prod_name_service}" />
                <input type="hidden" name="${prefix}.barcode" value="${item.barcode || ''}" />
                <input type="hidden" name="${prefix}.qty_unit_type" value="${item.qty}" />
                <input type="hidden" name="${prefix}.price" value="${item.price}" />
                <input type="hidden" name="${prefix}.discount" value="${item.discount}" />
                <input type="hidden" name="${prefix}.expiry_date" value="${item.expiry_date || ''}" />
                <input type="hidden" name="${prefix}.total_price" value="${lineTotal}" />
            `;
        });

        currentTotal = grandTotal;
        const format = (v) => (v < 0 ? '-' : '') + '$' + Math.abs(v).toLocaleString(undefined, { minimumFractionDigits: 2 });
        subtotalSpan.innerText = format(totalSub);
        discountSpan.innerText = (totalDisc >= 0 ? '-$' : '$') + Math.abs(totalDisc).toLocaleString(undefined, { minimumFractionDigits: 2 });
        grandTotalSpan.innerText = format(grandTotal);
    }

    function showStockAlert(msg) {
        const el = document.getElementById('stockAlert');
        document.getElementById('stockAlertMsg').innerText = msg;
        el.style.display = 'block';
        setTimeout(() => el.style.display = 'none', 3000);
    }

    // Modern Modal Flow
    function openPaymentModal() {
        if (saleItems.length === 0) return alert("Cart is empty.");
        
        const format = (v) => (v < 0 ? '-' : '') + '$' + Math.abs(v).toLocaleString(undefined, { minimumFractionDigits: 2 });
        document.getElementById('webModalTotal').innerText = format(currentTotal);
        
        // Reset inputs
        document.getElementById('webTendered').value = "";
        calculateWebChange();
        
        document.getElementById('paymentModal').classList.add('show');
    }

    function closePaymentModal() {
        document.getElementById('paymentModal').classList.remove('show');
    }

    function setWebPaymentMethod(method) {
        document.getElementById('hiddenPaymentMethod').value = method;
        document.getElementById('hiddenStatus').value = (method === 'Credit') ? 'Pending' : 'Paid';
        
        document.querySelectorAll('.method-tab').forEach(t => t.classList.remove('active'));
        event.currentTarget.classList.add('active');
    }

    function calculateWebChange() {
        const tendered = parseFloat(document.getElementById('webTendered').value) || 0;
        const change = tendered - currentTotal;
        
        const format = (v) => (v < 0 ? '-' : '') + '$' + Math.abs(v).toLocaleString(undefined, { minimumFractionDigits: 2 });
        document.getElementById('webModalTendered').innerText = format(tendered);
        document.getElementById('webModalChange').innerText = format(change);
    }

    function addWebAmount(amt) {
        const el = document.getElementById('webTendered');
        el.value = (parseFloat(el.value || 0) + amt).toFixed(2);
        calculateWebChange();
    }

    function matchWebAmount() {
        document.getElementById('webTendered').value = Math.max(0, currentTotal).toFixed(2);
        calculateWebChange();
    }

    function submitSaleForm() {
        const cust = document.querySelector('select[name="customer_name"]').value;
        if (!cust) return alert("Please select a customer first.");
        
        const method = document.getElementById('hiddenPaymentMethod').value;
        const tendered = parseFloat(document.getElementById('webTendered').value) || 0;
        
        if (method === 'Cash' && currentTotal > 0 && tendered < currentTotal) {
            if (!confirm("Partial payment? Remaining balance will be recorded as credit.")) return;
        }
        
        document.getElementById('saleForm').submit();
    }
</script>
