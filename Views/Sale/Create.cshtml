@model E_Invoice_system.Models.Sale
@{
    Layout = "_SaleLayout";
    var customers = ViewBag.Customers as List<E_Invoice_system.Models.customers>;
    var products = ViewBag.Products as List<E_Invoice_system.Models.ProductService>;
}

<div class="pos-container-v2">
    <!-- Left: Slim Category Sidebar -->
    <aside class="category-sidebar">
        <div class="category-item active" onclick="filterByCategory('all')">
            <i class="ph-grid-four"></i>
            <span>All</span>
        </div>
        <div class="category-item" onclick="filterByCategory('products')">
            <i class="ph-package"></i>
            <span>Items</span>
        </div>
        <div class="category-item" onclick="filterByCategory('services')">
            <i class="ph-sparkle"></i>
            <span>Service</span>
        </div>
        <div class="category-item" onclick="filterByCategory('fav')">
            <i class="ph-star"></i>
            <span>Saved</span>
        </div>
    </aside>

    <!-- Center: Product Discovery -->
    <div class="product-canvas">
        <div class="canvas-header">
            <div class="search-bar-v2">
                <i class="ph-magnifying-glass"></i>
                <input type="text" id="prodSearch" placeholder="Search products or scan barcode..." oninput="filterProducts()" />
            </div>
            
            <div class="search-toggle-v2">
                <div class="toggle-pill">
                    <input type="radio" id="searchName" name="searchMode" value="name" checked onchange="handleSearchModeChange()">
                    <label for="searchName">Name</label>
                    <input type="radio" id="searchBarcode" name="searchMode" value="barcode" onchange="handleSearchModeChange()">
                    <label for="searchBarcode">Barcode</label>
                </div>
            </div>
        </div>

        <div class="product-grid-v2" id="productGrid">
            @if (products != null)
            {
                foreach (var p in products)
                {
                    decimal stockValue = 0;
                    if (!string.IsNullOrEmpty(p.qty_unit_type))
                    {
                        var parts = p.qty_unit_type.Trim().Split(' ');
                        decimal.TryParse(parts[0], out stockValue);
                    }
                    <div class="product-card-v2" data-name="@p.prod_name_service.ToLower()" data-barcode="@(p.barcode?.ToLower() ?? "")" data-stock="@stockValue" onclick="addToSaleFromCard(@p.id, '@p.prod_name_service', @p.price, @p.discount, '@(p.expiry_date?.ToString("yyyy-MM-dd"))', '@(p.barcode ?? "")', @stockValue)">
                        <div class="card-status-pill @(stockValue <= 0 ? "out" : "in")">
                            @(stockValue <= 0 ? "Out of Stock" : $"{stockValue} Available")
                        </div>
                        <div class="card-icon">
                            <i class="ph-cube-transparent"></i>
                        </div>
                        <div class="card-info">
                            <h4 class="card-name">@p.prod_name_service</h4>
                            <div class="card-price-row">
                                <span class="price-tag">$@p.price.ToString("N2")</span>
                                @if (p.discount > 0)
                                {
                                    <span class="discount-pill">-$@p.discount.ToString("N2")</span>
                                }
                            </div>
                        </div>
                    </div>
                }
            }
        </div>
    </div>

    <!-- Right: Checkout Center -->
    <div class="checkout-center">
        <form asp-action="Create" method="post" id="saleForm" class="checkout-form">
            @Html.AntiForgeryToken()
            <input type="hidden" name="payment_method" id="hiddenPaymentMethod" value="Cash" />
            <input type="hidden" name="status" id="hiddenStatus" value="Paid" />
            
            <div class="checkout-header">
                <div style="flex: 1;">
                    <h3 style="margin: 0;">Current Order</h3>
                    <p id="itemCountDisplay" style="margin: 0;">0 items selected</p>
                </div>
                <div class="mode-toggle-v2 compact">
                    <div class="toggle-pill">
                        <input type="radio" id="modeSale" name="transMode" value="sale" checked onchange="handleModeChange()">
                        <label for="modeSale">Sale</label>
                        <input type="radio" id="modeReturn" name="transMode" value="return" onchange="handleModeChange()">
                        <label for="modeReturn">Return</label>
                    </div>
                </div>
                <button type="button" class="btn-clear-v2" onclick="clearSaleItems()">
                    <i class="ph-trash"></i>
                </button>
            </div>

            <div class="customer-selector-v2">
                <label>Customer</label>
                <div class="select-wrapper-v2">
                    <i class="ph-user-circle"></i>
                    <select name="customer_name" required>
                        <option value="">Select Customer</option>
                        @if (customers != null)
                        {
                            foreach (var c in customers)
                            {
                                <option value="@c.name">@c.name</option>
                            }
                        }
                    </select>
                </div>
            </div>

            <div class="checkout-items-v2" id="saleItemsBody">
                <!-- Items populated by JS -->
            </div>

            <div id="emptyStateV2" class="empty-state-v2">
                <div class="empty-glow"></div>
                <i class="ph-shopping-cart-simple"></i>
                <p>Bag is empty</p>
            </div>

            <div class="checkout-footer-v2">
                <div class="price-summary-v2">
                    <div class="summary-line">
                        <span>Items Total</span>
                        <span id="subtotalDisplay">$0.00</span>
                    </div>
                    <div class="summary-line highlight">
                        <span>Discounts</span>
                        <span id="discountDisplay">-$0.00</span>
                    </div>
                    
                    <div id="stockAlert" class="alert-v2" style="display: none;">
                        <i class="ph-warning"></i> <span id="stockAlertMsg"></span>
                    </div>

                    <div class="grand-total-row">
                        <div class="total-label">Grand Total</div>
                        <div class="total-value" id="grandTotal">$0.00</div>
                    </div>
                </div>

                <div id="hiddenInputsContainer"></div>

                <button type="button" class="btn-pay-v2" onclick="openPaymentModal()">
                    Payment
                    <i class="ph-arrow-right"></i>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modern Web Payment Modal -->
<div class="modal-overlay" id="paymentModal">
    <div class="payment-card">
        <!-- Left Side: Payment Input -->
        <div class="payment-left">
            <h1 class="payment-title">Checkout</h1>
            <p class="payment-subtitle">Complete your transaction by selecting a payment method.</p>
            
            <div class="method-tabs">
                <div class="method-tab active" id="btnCash" onclick="setWebPaymentMethod('Cash')">
                    <i class="ph-money"></i> <span>Cash</span>
                </div>
                <div class="method-tab" id="btnCard" onclick="setWebPaymentMethod('Card')">
                    <i class="ph-credit-card"></i> <span>Card</span>
                </div>
                <div class="method-tab" id="btnTransfer" onclick="setWebPaymentMethod('Transfer')">
                    <i class="ph-bank"></i> <span>Bank</span>
                </div>
                <div class="method-tab" id="btnCredit" onclick="setWebPaymentMethod('Credit')">
                    <i class="ph-user-focus"></i> <span>Credit</span>
                </div>
            </div>

            <div class="web-input-group">
                <label>Amount Tendered</label>
                <input type="number" id="webTendered" class="web-input" placeholder="0.00" oninput="calculateWebChange()" step="0.01">
                
                <div class="quick-pills">
                    <div class="quick-pill" onclick="addWebAmount(10)">+ $10</div>
                    <div class="quick-pill" onclick="addWebAmount(20)">+ $20</div>
                    <div class="quick-pill" onclick="addWebAmount(50)">+ $50</div>
                    <div class="quick-pill" onclick="addWebAmount(100)">+ $100</div>
                    <div class="quick-pill" onclick="matchWebAmount()">Match Total</div>
                </div>
            </div>

            <div class="web-input-group">
                <label>Reference / Note</label>
                <input type="text" name="notes" class="web-input" placeholder="Transaction notes (optional)">
            </div>
        </div>

        <!-- Right Side: Summary & Confirm -->
        <div class="payment-right">
            <div class="summary-box-web">
                <div class="summary-web-line">
                    <span style="color: var(--text-muted); font-weight: 600;">Total Amount Due</span>
                    <span id="webModalTotal" style="font-weight: 700;">$0.00</span>
                </div>
                <div class="summary-web-line" style="margin-top: 8px;">
                    <span style="color: var(--text-muted); font-weight: 600;">Total Tendered</span>
                    <span id="webModalTendered" style="font-weight: 700;">$0.00</span>
                </div>
                
                <div class="summary-web-line grand">
                    <span>Change Due</span>
                    <span id="webModalChange">$0.00</span>
                </div>
            </div>

            <div style="margin-top: auto;">
                <p style="font-size: 0.75rem; color: var(--text-muted); text-align: center; margin-bottom: 24px; line-height: 1.5;">
                    By completing this order, you agree to generate an official invoice and update stock levels.
                </p>
                
                <div style="display: flex; gap: 16px;">
                    <button type="button" class="btn-confirm-web" style="background: var(--surface); color: var(--text-muted); border: 1px solid var(--border); flex: 1;" onclick="closePaymentModal()">Cancel</button>
                    <button type="button" class="btn-confirm-web" style="flex: 2; background: var(--primary); color: white;" onclick="submitSaleForm()">
                        Complete Order <i class="ph-check-circle"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let saleItems = [];
    let currentTotal = 0;
    let searchMode = 'name'; // Default search mode

    function handleSearchModeChange() {
        searchMode = document.querySelector('input[name="searchMode"]:checked').value;
        const input = document.getElementById('prodSearch');
        input.placeholder = searchMode === 'name' ? "Search by product name..." : "Scan or enter barcode...";
        input.value = '';
        filterProducts();
        input.focus();
    }

    function filterByCategory(cat) {
        document.querySelectorAll('.category-item').forEach(el => el.classList.remove('active'));
        event.currentTarget.classList.add('active');
        
        const cards = document.querySelectorAll('.product-card-v2');
        cards.forEach(card => {
            if (cat === 'all') card.style.display = '';
            else if (cat === 'fav') {
                card.style.display = card.dataset.stock > 10 ? '' : 'none';
            }
        });
    }

    function filterProducts() {
        const query = document.getElementById('prodSearch').value.toLowerCase();
        const cards = document.querySelectorAll('.product-card-v2');

        cards.forEach(card => {
            const name = card.dataset.name;
            const barcode = card.dataset.barcode;
            
            if (searchMode === 'name') {
                card.style.display = name.includes(query) ? '' : 'none';
            } else {
                card.style.display = barcode.includes(query) ? '' : 'none';
            }
        });
    }

    function addToSaleFromCard(id, name, price, discount, expiry, barcode, maxStock) {
        const mode = document.querySelector('input[name="transMode"]:checked').value;
        const isReturn = mode === 'return';
        const qtyToAdd = isReturn ? -1 : 1;

        const existing = saleItems.find(i => i.prod_name_service === name);
        if (existing) {
            if (!isReturn && (existing.qty + qtyToAdd) > maxStock) {
                showStockAlert(`Only ${maxStock} items available.`);
                return;
            }
            existing.qty += qtyToAdd;
            if (existing.qty === 0) {
                removeItem(saleItems.indexOf(existing));
                return;
            }
            existing.total_price = (existing.price * existing.qty) - (existing.discount * existing.qty);
        } else {
            if (!isReturn && qtyToAdd > maxStock) {
                showStockAlert(`Insufficient stock (${maxStock}).`);
                return;
            }
            saleItems.push({
                prod_name_service: name,
                barcode: barcode || null,
                qty: qtyToAdd,
                price: price,
                discount: discount,
                expiry_date: expiry || null,
                maxStock: maxStock,
                total_price: (price * qtyToAdd) - (discount * qtyToAdd)
            });
        }
        renderSaleItems();
    }

    function decreaseQty(index) {
        saleItems[index].qty--;
        if (saleItems[index].qty === 0) {
            removeItem(index);
        } else {
            const item = saleItems[index];
            item.total_price = (item.price * item.qty) - (item.discount * item.qty);
            renderSaleItems();
        }
    }

    function increaseQty(index) {
        const item = saleItems[index];
        const mode = document.querySelector('input[name="transMode"]:checked').value;
        if (mode !== 'return' && item.qty >= item.maxStock) {
            showStockAlert(`Max stock reached (${item.maxStock}).`);
            return;
        }
        item.qty++;
        item.total_price = (item.price * item.qty) - (item.discount * item.qty);
        renderSaleItems();
    }

    function removeItem(index) {
        saleItems.splice(index, 1);
        renderSaleItems();
    }

    function clearSaleItems() {
        if (saleItems.length > 0 && confirm("Clear current order?")) {
            saleItems = [];
            renderSaleItems();
        }
    }

    function renderSaleItems() {
        const body = document.getElementById('saleItemsBody');
        const empty = document.getElementById('emptyStateV2');
        const hiddenContainer = document.getElementById('hiddenInputsContainer');
        const subtotalSpan = document.getElementById('subtotalDisplay');
        const discountSpan = document.getElementById('discountDisplay');
        const grandTotalSpan = document.getElementById('grandTotal');
        const countDisplay = document.getElementById('itemCountDisplay');

        body.innerHTML = "";
        hiddenContainer.innerHTML = "";

        countDisplay.innerText = `${saleItems.length} item${saleItems.length !== 1 ? 's' : ''} selected`;

        if (saleItems.length === 0) {
            empty.style.display = "flex";
            subtotalSpan.innerText = "$0.00";
            discountSpan.innerText = "-$0.00";
            grandTotalSpan.innerText = "$0.00";
            currentTotal = 0;
            return;
        }
        empty.style.display = "none";

        let totalSub = 0;
        let totalDisc = 0;
        let grandTotal = 0;

        saleItems.forEach((item, index) => {
            const lineSub = item.price * item.qty;
            const lineDisc = item.discount * item.qty;
            const lineTotal = lineSub - lineDisc;

            totalSub += lineSub;
            totalDisc += lineDisc;
            grandTotal += lineTotal;

            const div = document.createElement('div');
            div.className = "item-v2";
            div.innerHTML = `
                <div class="item-v2-main">
                    <div class="title">${item.prod_name_service}</div>
                    <div class="meta">$${item.price.toFixed(2)} / unit</div>
                </div>
                <div class="item-v2-controls">
                    <div class="qty-pill-v2">
                        <button type="button" onclick="decreaseQty(${index})">-</button>
                        <span>${item.qty}</span>
                        <button type="button" onclick="increaseQty(${index})">+</button>
                    </div>
                    <div class="item-v2-price">$${lineTotal.toFixed(2)}</div>
                </div>
            `;
            body.appendChild(div);

            const prefix = `items[${index}]`;
            hiddenContainer.innerHTML += `
                <input type="hidden" name="${prefix}.prod_name_service" value="${item.prod_name_service}" />
                <input type="hidden" name="${prefix}.barcode" value="${item.barcode || ''}" />
                <input type="hidden" name="${prefix}.qty_unit_type" value="${item.qty}" />
                <input type="hidden" name="${prefix}.price" value="${item.price}" />
                <input type="hidden" name="${prefix}.discount" value="${item.discount}" />
                <input type="hidden" name="${prefix}.expiry_date" value="${item.expiry_date || ''}" />
                <input type="hidden" name="${prefix}.total_price" value="${lineTotal}" />
            `;
        });

        currentTotal = grandTotal;
        const format = (v) => (v < 0 ? '-' : '') + '$' + Math.abs(v).toLocaleString(undefined, { minimumFractionDigits: 2 });
        subtotalSpan.innerText = format(totalSub);
        discountSpan.innerText = (totalDisc >= 0 ? '-$' : '$') + Math.abs(totalDisc).toLocaleString(undefined, { minimumFractionDigits: 2 });
        grandTotalSpan.innerText = format(grandTotal);
    }

    function showStockAlert(msg) {
        const el = document.getElementById('stockAlert');
        document.getElementById('stockAlertMsg').innerText = msg;
        el.style.display = 'block';
        setTimeout(() => el.style.display = 'none', 3000);
    }

    function handleModeChange() {
        const mode = document.querySelector('input[name="transMode"]:checked').value;
        const isReturn = mode === 'return';
        saleItems.forEach(item => {
            const absQty = Math.abs(item.qty);
            item.qty = isReturn ? -absQty : absQty;
            item.total_price = (item.price * item.qty) - (item.discount * item.qty);
        });
        renderSaleItems();
    }

    function openPaymentModal() {
        if (saleItems.length === 0) return alert("Cart is empty.");
        const format = (v) => (v < 0 ? '-' : '') + '$' + Math.abs(v).toLocaleString(undefined, { minimumFractionDigits: 2 });
        document.getElementById('webModalTotal').innerText = format(currentTotal);
        document.getElementById('webTendered').value = "";
        calculateWebChange();
        document.getElementById('paymentModal').classList.add('show');
    }

    function closePaymentModal() {
        document.getElementById('paymentModal').classList.remove('show');
    }

    function setWebPaymentMethod(method) {
        document.getElementById('hiddenPaymentMethod').value = method;
        document.getElementById('hiddenStatus').value = (method === 'Credit') ? 'Pending' : 'Paid';
        document.querySelectorAll('.method-tab').forEach(t => t.classList.remove('active'));
        event.currentTarget.classList.add('active');
    }

    function calculateWebChange() {
        const tendered = parseFloat(document.getElementById('webTendered').value) || 0;
        const change = tendered - currentTotal;
        const format = (v) => (v < 0 ? '-' : '') + '$' + Math.abs(v).toLocaleString(undefined, { minimumFractionDigits: 2 });
        document.getElementById('webModalTendered').innerText = format(tendered);
        document.getElementById('webModalChange').innerText = format(change);
    }

    function addWebAmount(amt) {
        const el = document.getElementById('webTendered');
        el.value = (parseFloat(el.value || 0) + amt).toFixed(2);
        calculateWebChange();
    }

    function matchWebAmount() {
        document.getElementById('webTendered').value = Math.max(0, currentTotal).toFixed(2);
        calculateWebChange();
    }

    function submitSaleForm() {
        const cust = document.querySelector('select[name="customer_name"]').value;
        if (!cust) return alert("Please select a customer.");
        document.getElementById('saleForm').submit();
    }
</script>
