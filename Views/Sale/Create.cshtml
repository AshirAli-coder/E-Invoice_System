@model E_Invoice_system.Models.Sale
@{
    var buyers = ViewBag.Buyers as List<E_Invoice_system.Models.buyers>;
}

<div class="dashboard-panel">
    <div class="page-header">
        <h1 class="page-title-large">
            Create New Sale Transaction
        </h1>
        <a asp-action="Index" class="btn-secondary">
            <i class="ph-arrow-left"></i> Back to List
        </a>
    </div>

    <div class="form-wrapper">
        <form asp-action="Create" method="post" id="saleForm">
            @Html.AntiForgeryToken()

            <!-- Section 1: Sale Details -->
            <div class="form-section">
                <div class="form-section-header">
                    <h3 class="form-section-title">
                        <i class="ph-receipt" style="color: var(--primary);"></i>
                        Sale Information
                    </h3>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Buyer Name</label>
                        <select name="buyer_name" class="form-control" required>
                            <option value="">-- Select --</option>
                            @if (buyers != null)
                            {
                                foreach (var b in buyers)
                                {
                                    <option value="@b.name">@b.name</option>
                                }
                            }
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Payment Method</label>
                        <select name="payment_method" class="form-control" required>
                            <option value="Cash">Cash Sale</option>
                            <option value="Card">Card Payment</option>
                            <option value="Online">Online Transfer</option>
                            <option value="Credit">Credit</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select name="status" class="form-control" required>
                            <option value="Paid">Paid</option>
                            <option value="Pending">Pending</option>
                            <option value="Cancelled">Cancelled</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Section 2: Product Entry -->
            <div class="form-section">
                <div class="form-section-header">
                    <h3 class="form-section-title">
                        <i class="ph-package" style="color: var(--primary);"></i>
                        Add Products
                    </h3>
                </div>

                <div style="background: var(--bg-light); border: 1px solid var(--border); border-radius: 8px; padding: 1.5rem; margin-bottom: 2rem;">
                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 1.5fr auto; gap: 1rem; align-items: flex-end;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Product / Service</label>
                            <select id="prodSelect" class="form-control">
                                <option value="">-- Select Product --</option>
                                @foreach (var p in ViewBag.Products as List<E_Invoice_system.Models.ProductService>)
                                {
                                    <option value="@p.id" data-name="@p.prod_name_service" data-price="@p.price" data-discount="@p.discount" data-expiry="@(p.expiry_date?.ToString("yyyy-MM-dd"))">@p.prod_name_service</option>
                                }
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Qty/Unit</label>
                            <input type="text" id="rowQty" placeholder="1" class="form-control" />
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Price ($)</label>
                            <input type="number" id="rowPrice" step="0.01" class="form-control" />
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Disc ($)</label>
                            <input type="number" id="rowDisc" step="0.01" class="form-control" />
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Expiry Date</label>
                            <input type="date" id="rowExp" class="form-control" />
                        </div>
                        <button type="button" onclick="addToSale()" class="btn-primary" style="margin-bottom: 2px;">
                            <i class="ph-plus-bold"></i> Add
                        </button>
                    </div>
                </div>

                <!-- Items Table -->
                <div style="overflow-x: auto; margin-bottom: 1.5rem; border: 1px solid var(--border); border-radius: 8px;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead style="background: var(--bg-light); border-bottom: 1px solid var(--border);">
                            <tr>
                                <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--text-muted);">Product Name</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--text-muted);">Qty</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--text-muted);">Unit Price</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--text-muted);">Discount</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--text-muted);">Expiry</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600; color: var(--text-muted);">Total</th>
                                <th style="padding: 1rem; text-align: center; width: 60px;"></th>
                            </tr>
                        </thead>
                        <tbody id="saleItemsBody" style="background: white;"></tbody>
                    </table>
                    <div id="emptyState" style="padding: 3rem; text-align: center; color: var(--text-muted);">
                        <i class="ph-shopping-cart" style="font-size: 2.5rem; margin-bottom: 1rem; display: block; opacity: 0.3;"></i>
                        No items added to the sale yet.
                    </div>
                </div>
            </div>

            <!-- Section 3: Summary & Notes -->
            <div class="form-section">
                 <div class="form-section-header">
                    <h3 class="form-section-title">
                        <i class="ph-note-pencil" style="color: var(--primary);"></i>
                        Notes & Total
                    </h3>
                </div>
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem; align-items: start;">
                    <div class="form-group">
                        <label class="form-label">Description / Internal Notes (Optional)</label>
                        <textarea name="description" rows="3" class="form-control" placeholder="Type any remarks about this transaction..." data-val="false"></textarea>
                    </div>
                    <div style="display: flex; flex-direction: column; align-items: flex-end; justify-content: flex-end; padding-top: 1.5rem;">
                        <span style="font-size: 1rem; font-weight: 600; color: var(--text-muted);">Grand Total</span>
                        <span id="grandTotal" style="font-size: 2rem; font-weight: 800; color: var(--primary);">$0.00</span>
                    </div>
                </div>
            </div>

            <!-- Hidden inputs for posting -->
            <div id="hiddenInputsContainer"></div>

            <div class="form-actions-sticky">
                <a asp-action="Index" class="btn-secondary">
                    Cancel
                </a>
                <button type="submit" class="btn-primary">
                    <i class="ph-check"></i>
                    Save Sale
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    let saleItems = [];

    document.getElementById('prodSelect').addEventListener('change', function() {
        const opt = this.options[this.selectedIndex];
        const priceInput = document.getElementById('rowPrice');
        const discInput = document.getElementById('rowDisc');
        const expInput = document.getElementById('rowExp');

        if (opt.value) {
            priceInput.value = opt.dataset.price;
            discInput.value = opt.dataset.discount;
            expInput.value = opt.dataset.expiry || "";
            document.getElementById('rowQty').value = "1";
            
            // Make fields read-only
            priceInput.readOnly = true;
            discInput.readOnly = true;
            expInput.readOnly = true;
        } else {
            // Make fields editable if no product selected
            priceInput.readOnly = false;
            discInput.readOnly = false;
            expInput.readOnly = false;
            
            // Clear values
            priceInput.value = "";
            discInput.value = "";
            expInput.value = "";
            document.getElementById('rowQty').value = "";
        }
    });

    function addToSale() {
        const select = document.getElementById('prodSelect');
        const opt = select.options[select.selectedIndex];
        if (!opt.value) { alert("Please select a product!"); return; }

        const item = {
            prod_name_service: opt.dataset.name,
            qty_unit_type: document.getElementById('rowQty').value || "1",
            price: parseFloat(document.getElementById('rowPrice').value) || 0,
            discount: parseFloat(document.getElementById('rowDisc').value) || 0,
            expiry_date: document.getElementById('rowExp').value || null
        };
        const qtyNum = parseFloat(item.qty_unit_type.split(' ')[0]) || 0;
        item.total_price = (item.price * qtyNum) - item.discount;

        saleItems.push(item);
        renderSaleItems();

        // reset inputs
        select.value = "";
        document.getElementById('rowQty').value = "";
        document.getElementById('rowPrice').value = "";
        document.getElementById('rowDisc').value = "";
        document.getElementById('rowExp').value = "";
    }

    function removeItem(index) {
        saleItems.splice(index, 1);
        renderSaleItems();
    }

    function renderSaleItems() {
        const body = document.getElementById('saleItemsBody');
        const empty = document.getElementById('emptyState');
        const hiddenContainer = document.getElementById('hiddenInputsContainer');
        const grandTotalSpan = document.getElementById('grandTotal');

        body.innerHTML = "";
        hiddenContainer.innerHTML = "";

        if (saleItems.length === 0) {
            empty.style.display = "block";
            grandTotalSpan.innerText = "$0.00";
            return;
        }
        empty.style.display = "none";

        let grandTotal = 0;
        saleItems.forEach((item, index) => {
            grandTotal += item.total_price;

            const tr = document.createElement('tr');
            tr.style.borderBottom = "1px solid var(--border)";
            tr.innerHTML = `
                <td style="padding: 1rem; font-weight: 500;">${item.prod_name_service}</td>
                <td style="padding: 1rem;">${item.qty_unit_type}</td>
                <td style="padding: 1rem; color: var(--text-muted);">$${item.price.toFixed(2)}</td>
                <td style="padding: 1rem; color: #ef4444;">$${item.discount.toFixed(2)}</td>
                <td style="padding: 1rem; color: var(--text-muted); font-size: 0.85rem;">${item.expiry_date || 'N/A'}</td>
                <td style="padding: 1rem; font-weight: 700; color: var(--primary);">$${item.total_price.toFixed(2)}</td>
                <td style="padding: 1rem; text-align: center;">
                    <button type="button" onclick="removeItem(${index})" style="background: #fee2e2; color: #ef4444; border: none; width: 32px; height: 32px; border-radius: 6px; cursor: pointer; display: inline-flex; align-items: center; justify-content: center;">
                        <i class="ph-trash"></i>
                    </button>
                </td>
            `;
            body.appendChild(tr);

            const prefix = `items[${index}]`;
            hiddenContainer.innerHTML += `
                <input type="hidden" name="${prefix}.prod_name_service" value="${item.prod_name_service}" />
                <input type="hidden" name="${prefix}.qty_unit_type" value="${item.qty_unit_type}" />
                <input type="hidden" name="${prefix}.price" value="${item.price}" />
                <input type="hidden" name="${prefix}.discount" value="${item.discount}" />
                <input type="hidden" name="${prefix}.expiry_date" value="${item.expiry_date}" />
                <input type="hidden" name="${prefix}.total_price" value="${item.total_price}" />
            `;
        });

        grandTotalSpan.innerText = "$" + grandTotal.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }
</script>
